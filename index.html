<!DOCTYPE html>
<html lang="nl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ScriptMaster Pro</title>
    <link rel="manifest" href="manifest.json">
    <meta name="theme-color" content="#0f172a">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <link rel="apple-touch-icon" href="icon-192.png">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.174/pdf.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/mammoth/1.6.0/mammoth.browser.min.js"></script>
    <script src="https://unpkg.com/lucide@latest"></script>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        
        :root {
            --bg-primary: #0f172a;
            --bg-secondary: #1e293b;
            --bg-tertiary: #334155;
            --text-primary: #f8fafc;
            --text-secondary: #94a3b8;
            --text-muted: #64748b;
            --accent: #f59e0b;
            --accent-hover: #d97706;
            --success: #22c55e;
            --error: #ef4444;
            --border: #475569;
        }
        
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background: var(--bg-primary);
            color: var(--text-primary);
            min-height: 100vh;
            line-height: 1.5;
        }
        
        /* Glass morphism */
        .glass {
            background: rgba(30, 41, 59, 0.8);
            backdrop-filter: blur(12px);
            border: 1px solid rgba(71, 85, 105, 0.5);
        }
        
        .glass-light {
            background: rgba(51, 65, 85, 0.5);
            backdrop-filter: blur(8px);
        }
        
        /* Layout */
        .app-container {
            display: flex;
            flex-direction: column;
            height: 100vh;
            max-height: 100vh;
            overflow: hidden;
        }
        
        /* Header */
        .header {
            padding: 1rem 1.5rem;
            display: flex;
            align-items: center;
            justify-content: space-between;
            border-bottom: 1px solid var(--border);
        }
        
        .logo {
            display: flex;
            align-items: center;
            gap: 0.75rem;
        }
        
        .logo-icon {
            width: 40px;
            height: 40px;
            background: linear-gradient(135deg, var(--accent), #fbbf24);
            border-radius: 10px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 1.5rem;
        }
        
        .logo h1 {
            font-size: 1.5rem;
            font-weight: 700;
            background: linear-gradient(135deg, var(--accent), #fbbf24);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
        }
        
        .header-actions {
            display: flex;
            gap: 0.5rem;
        }
        
        /* Navigation */
        .nav-tabs {
            display: flex;
            gap: 0.25rem;
            padding: 0.75rem 1rem;
            overflow-x: auto;
            border-bottom: 1px solid var(--border);
            background: var(--bg-secondary);
        }
        
        .nav-tab {
            display: flex;
            align-items: center;
            gap: 0.5rem;
            padding: 0.75rem 1.25rem;
            border-radius: 8px;
            border: none;
            background: transparent;
            color: var(--text-secondary);
            cursor: pointer;
            font-size: 0.9rem;
            font-weight: 500;
            white-space: nowrap;
            transition: all 0.2s;
        }
        
        .nav-tab:hover {
            background: var(--bg-tertiary);
            color: var(--text-primary);
        }
        
        .nav-tab.active {
            background: var(--accent);
            color: var(--bg-primary);
        }
        
        .nav-tab i {
            width: 18px;
            height: 18px;
        }
        
        /* Main content */
        .main-content {
            flex: 1;
            overflow-y: auto;
            padding: 1.5rem;
        }
        
        /* Buttons */
        .btn {
            display: inline-flex;
            align-items: center;
            justify-content: center;
            gap: 0.5rem;
            padding: 0.75rem 1.5rem;
            border-radius: 8px;
            border: none;
            font-size: 0.9rem;
            font-weight: 500;
            cursor: pointer;
            transition: all 0.2s;
        }
        
        .btn-primary {
            background: var(--accent);
            color: var(--bg-primary);
        }
        
        .btn-primary:hover {
            background: var(--accent-hover);
        }
        
        .btn-secondary {
            background: var(--bg-tertiary);
            color: var(--text-primary);
        }
        
        .btn-secondary:hover {
            background: var(--border);
        }
        
        .btn-ghost {
            background: transparent;
            color: var(--text-secondary);
            padding: 0.5rem;
        }
        
        .btn-ghost:hover {
            background: var(--bg-tertiary);
            color: var(--text-primary);
        }
        
        .btn i {
            width: 18px;
            height: 18px;
        }
        
        /* Cards */
        .card {
            background: var(--bg-secondary);
            border-radius: 12px;
            border: 1px solid var(--border);
            overflow: hidden;
        }
        
        .card-header {
            padding: 1rem 1.25rem;
            border-bottom: 1px solid var(--border);
            display: flex;
            align-items: center;
            justify-content: space-between;
        }
        
        .card-header h3 {
            font-size: 1rem;
            font-weight: 600;
        }
        
        .card-body {
            padding: 1.25rem;
        }
        
        /* Grid layouts */
        .grid-2 {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(300px, 1fr));
            gap: 1rem;
        }
        
        .grid-3 {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(250px, 1fr));
            gap: 1rem;
        }
        
        /* Upload zone */
        .upload-zone {
            border: 2px dashed var(--border);
            border-radius: 12px;
            padding: 3rem 2rem;
            text-align: center;
            cursor: pointer;
            transition: all 0.2s;
        }
        
        .upload-zone:hover, .upload-zone.dragover {
            border-color: var(--accent);
            background: rgba(245, 158, 11, 0.1);
        }
        
        .upload-zone i {
            width: 48px;
            height: 48px;
            color: var(--accent);
            margin-bottom: 1rem;
        }
        
        .upload-zone h3 {
            font-size: 1.1rem;
            margin-bottom: 0.5rem;
        }
        
        .upload-zone p {
            color: var(--text-secondary);
            font-size: 0.9rem;
        }
        
        /* Script list */
        .script-item {
            display: flex;
            align-items: center;
            gap: 1rem;
            padding: 1rem;
            background: var(--bg-tertiary);
            border-radius: 8px;
            cursor: pointer;
            transition: all 0.2s;
        }
        
        .script-item:hover {
            background: var(--border);
        }
        
        .script-icon {
            width: 48px;
            height: 48px;
            background: var(--bg-secondary);
            border-radius: 8px;
            display: flex;
            align-items: center;
            justify-content: center;
        }
        
        .script-icon i {
            width: 24px;
            height: 24px;
            color: var(--accent);
        }
        
        .script-info {
            flex: 1;
            min-width: 0;
        }
        
        .script-title {
            font-weight: 600;
            margin-bottom: 0.25rem;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }
        
        .script-meta {
            font-size: 0.85rem;
            color: var(--text-secondary);
        }
        
        .script-actions {
            display: flex;
            gap: 0.25rem;
        }
        
        /* Stats badges */
        .stat-badge {
            display: inline-flex;
            align-items: center;
            gap: 0.25rem;
            padding: 0.25rem 0.5rem;
            background: var(--bg-tertiary);
            border-radius: 4px;
            font-size: 0.8rem;
            color: var(--text-secondary);
        }
        
        /* Character/Location cards */
        .entity-card {
            padding: 1rem;
            background: var(--bg-tertiary);
            border-radius: 8px;
            cursor: pointer;
            transition: all 0.2s;
        }
        
        .entity-card:hover {
            background: var(--border);
        }
        
        .entity-name {
            font-weight: 600;
            margin-bottom: 0.5rem;
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }
        
        .entity-stats {
            display: flex;
            gap: 1rem;
            font-size: 0.85rem;
            color: var(--text-secondary);
        }
        
        /* Storyframe */
        .storyframe-container {
            display: flex;
            flex-direction: column;
            gap: 1.5rem;
        }
        
        .storyframe-input {
            width: 100%;
            min-height: 150px;
            padding: 1rem;
            background: var(--bg-tertiary);
            border: 1px solid var(--border);
            border-radius: 8px;
            color: var(--text-primary);
            font-size: 1rem;
            resize: vertical;
        }
        
        .storyframe-input:focus {
            outline: none;
            border-color: var(--accent);
        }
        
        .genre-selector {
            display: flex;
            flex-wrap: wrap;
            gap: 0.5rem;
        }
        
        .genre-btn {
            padding: 0.5rem 1rem;
            background: var(--bg-tertiary);
            border: 1px solid var(--border);
            border-radius: 20px;
            color: var(--text-secondary);
            cursor: pointer;
            transition: all 0.2s;
        }
        
        .genre-btn:hover {
            border-color: var(--accent);
            color: var(--text-primary);
        }
        
        .genre-btn.active {
            background: var(--accent);
            border-color: var(--accent);
            color: var(--bg-primary);
        }
        
        .week-card {
            background: var(--bg-tertiary);
            border-radius: 8px;
            overflow: hidden;
        }
        
        .week-header {
            padding: 0.75rem 1rem;
            background: var(--bg-secondary);
            font-weight: 600;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        
        .week-content {
            padding: 1rem;
        }
        
        .act-badge {
            padding: 0.25rem 0.5rem;
            border-radius: 4px;
            font-size: 0.75rem;
            font-weight: 600;
        }
        
        .act-1 { background: #3b82f6; }
        .act-2 { background: #22c55e; }
        .act-3 { background: #f59e0b; }
        .act-4 { background: #ef4444; }
        .act-5 { background: #8b5cf6; }
        
        /* Chat */
        .chat-container {
            display: flex;
            flex-direction: column;
            height: calc(100vh - 180px);
        }
        
        .chat-messages {
            flex: 1;
            overflow-y: auto;
            padding: 1rem;
            display: flex;
            flex-direction: column;
            gap: 1rem;
        }
        
        .chat-message {
            max-width: 80%;
            padding: 1rem;
            border-radius: 12px;
        }
        
        .chat-message.user {
            background: var(--accent);
            color: var(--bg-primary);
            align-self: flex-end;
            border-bottom-right-radius: 4px;
        }
        
        .chat-message.assistant {
            background: var(--bg-tertiary);
            align-self: flex-start;
            border-bottom-left-radius: 4px;
        }
        
        .chat-input-container {
            padding: 1rem;
            border-top: 1px solid var(--border);
            display: flex;
            gap: 0.5rem;
        }
        
        .chat-input {
            flex: 1;
            padding: 0.75rem 1rem;
            background: var(--bg-tertiary);
            border: 1px solid var(--border);
            border-radius: 8px;
            color: var(--text-primary);
            font-size: 1rem;
        }
        
        .chat-input:focus {
            outline: none;
            border-color: var(--accent);
        }
        
        /* Wisdom cards */
        .wisdom-category {
            margin-bottom: 2rem;
        }
        
        .wisdom-category h3 {
            font-size: 1.1rem;
            margin-bottom: 1rem;
            color: var(--accent);
        }
        
        .wisdom-card {
            padding: 1rem;
            background: var(--bg-tertiary);
            border-radius: 8px;
            border-left: 3px solid var(--accent);
        }
        
        .wisdom-quote {
            font-style: italic;
            margin-bottom: 0.5rem;
        }
        
        .wisdom-author {
            font-size: 0.85rem;
            color: var(--text-secondary);
            text-align: right;
        }
        
        /* Modal */
        .modal-overlay {
            position: fixed;
            inset: 0;
            background: rgba(0, 0, 0, 0.7);
            display: flex;
            align-items: center;
            justify-content: center;
            padding: 1rem;
            z-index: 100;
        }
        
        .modal {
            background: var(--bg-secondary);
            border-radius: 12px;
            border: 1px solid var(--border);
            max-width: 500px;
            width: 100%;
            max-height: 90vh;
            overflow-y: auto;
        }
        
        .modal-header {
            padding: 1rem 1.25rem;
            border-bottom: 1px solid var(--border);
            display: flex;
            align-items: center;
            justify-content: space-between;
        }
        
        .modal-body {
            padding: 1.25rem;
        }
        
        .modal-footer {
            padding: 1rem 1.25rem;
            border-top: 1px solid var(--border);
            display: flex;
            justify-content: flex-end;
            gap: 0.5rem;
        }
        
        /* Form elements */
        .form-group {
            margin-bottom: 1rem;
        }
        
        .form-label {
            display: block;
            margin-bottom: 0.5rem;
            font-weight: 500;
            color: var(--text-secondary);
        }
        
        .form-input {
            width: 100%;
            padding: 0.75rem 1rem;
            background: var(--bg-tertiary);
            border: 1px solid var(--border);
            border-radius: 8px;
            color: var(--text-primary);
            font-size: 1rem;
        }
        
        .form-input:focus {
            outline: none;
            border-color: var(--accent);
        }
        
        /* Scene viewer */
        .scene-viewer {
            position: fixed;
            inset: 0;
            background: var(--bg-primary);
            z-index: 50;
            display: flex;
            flex-direction: column;
        }
        
        .scene-content {
            flex: 1;
            overflow-y: auto;
            padding: 2rem;
            max-width: 800px;
            margin: 0 auto;
        }
        
        .scene-header-text {
            font-family: 'Courier New', monospace;
            font-weight: bold;
            margin-bottom: 1.5rem;
            color: var(--accent);
        }
        
        .scene-action {
            font-family: 'Courier New', monospace;
            margin: 0.5rem 0;
        }
        
        .scene-character {
            font-family: 'Courier New', monospace;
            font-weight: bold;
            text-align: center;
            margin-top: 1.5rem;
            margin-bottom: 0;
        }
        
        .scene-dialogue {
            font-family: 'Courier New', monospace;
            margin: 0 auto;
            max-width: 400px;
            text-align: center;
        }
        
        .scene-parenthetical {
            font-family: 'Courier New', monospace;
            font-style: italic;
            text-align: center;
            color: var(--text-secondary);
        }
        
        /* Continuity */
        .continuity-issue {
            padding: 1rem;
            background: var(--bg-tertiary);
            border-radius: 8px;
            border-left: 3px solid var(--error);
            margin-bottom: 0.5rem;
        }
        
        .continuity-issue.warning {
            border-left-color: var(--accent);
        }
        
        .continuity-issue.ok {
            border-left-color: var(--success);
        }
        
        /* Writer Assistant Styles */
        .writer-container {
            display: flex;
            flex-direction: column;
            gap: 1.5rem;
        }
        
        .method-selector {
            display: flex;
            flex-wrap: wrap;
            gap: 0.5rem;
        }
        
        .method-btn {
            padding: 0.75rem 1.25rem;
            background: var(--bg-tertiary);
            border: 2px solid var(--border);
            border-radius: 8px;
            color: var(--text-secondary);
            cursor: pointer;
            transition: all 0.2s;
            font-size: 0.9rem;
        }
        
        .method-btn:hover {
            border-color: var(--accent);
            color: var(--text-primary);
        }
        
        .method-btn.active {
            background: var(--accent);
            border-color: var(--accent);
            color: var(--bg-primary);
        }
        
        .beat-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(200px, 1fr));
            gap: 0.75rem;
        }
        
        .beat-card {
            padding: 1rem;
            background: var(--bg-tertiary);
            border-radius: 8px;
            border: 2px solid var(--border);
            cursor: pointer;
            transition: all 0.2s;
        }
        
        .beat-card:hover {
            border-color: var(--accent);
        }
        
        .beat-card.active {
            border-color: var(--accent);
            background: rgba(245, 158, 11, 0.1);
        }
        
        .beat-card.completed {
            border-color: var(--success);
        }
        
        .beat-number {
            font-size: 0.75rem;
            color: var(--text-muted);
            margin-bottom: 0.25rem;
        }
        
        .beat-name {
            font-weight: 600;
            margin-bottom: 0.25rem;
        }
        
        .beat-status {
            font-size: 0.8rem;
        }
        
        .beat-status.empty { color: var(--text-muted); }
        .beat-status.filled { color: var(--success); }
        
        .beat-editor {
            background: var(--bg-secondary);
            border-radius: 12px;
            border: 1px solid var(--border);
            overflow: hidden;
        }
        
        .beat-editor-header {
            padding: 1rem 1.25rem;
            border-bottom: 1px solid var(--border);
            background: var(--bg-tertiary);
        }
        
        .beat-editor-body {
            padding: 1.25rem;
        }
        
        .beat-description {
            font-size: 0.9rem;
            color: var(--text-secondary);
            margin-bottom: 1rem;
            padding: 0.75rem;
            background: var(--bg-tertiary);
            border-radius: 8px;
        }
        
        .beat-textarea {
            width: 100%;
            min-height: 120px;
            padding: 1rem;
            background: var(--bg-tertiary);
            border: 1px solid var(--border);
            border-radius: 8px;
            color: var(--text-primary);
            font-size: 1rem;
            resize: vertical;
            margin-bottom: 1rem;
        }
        
        .beat-textarea:focus {
            outline: none;
            border-color: var(--accent);
        }
        
        .suggestion-buttons {
            display: flex;
            gap: 0.5rem;
            margin-bottom: 1rem;
        }
        
        .suggestions-container {
            display: flex;
            flex-direction: column;
            gap: 0.75rem;
        }
        
        .suggestion-card {
            padding: 1rem;
            background: var(--bg-tertiary);
            border-radius: 8px;
            border-left: 4px solid;
            cursor: pointer;
            transition: all 0.2s;
        }
        
        .suggestion-card:hover {
            background: var(--border);
        }
        
        .suggestion-card.conventional { border-left-color: #22c55e; }
        .suggestion-card.surprising { border-left-color: #f59e0b; }
        .suggestion-card.bold { border-left-color: #ef4444; }
        
        .suggestion-label {
            font-size: 0.8rem;
            font-weight: 600;
            margin-bottom: 0.5rem;
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }
        
        .suggestion-label.conventional { color: #22c55e; }
        .suggestion-label.surprising { color: #f59e0b; }
        .suggestion-label.bold { color: #ef4444; }
        
        .suggestion-text {
            font-size: 0.9rem;
            line-height: 1.5;
        }
        
        .master-tip {
            padding: 1rem;
            background: linear-gradient(135deg, rgba(245, 158, 11, 0.1), rgba(251, 191, 36, 0.05));
            border-radius: 8px;
            border: 1px solid rgba(245, 158, 11, 0.3);
            margin-top: 1rem;
        }
        
        .master-tip-header {
            display: flex;
            align-items: center;
            gap: 0.5rem;
            margin-bottom: 0.5rem;
            font-weight: 600;
            color: var(--accent);
        }
        
        .master-tip-quote {
            font-style: italic;
            margin-bottom: 0.5rem;
        }
        
        .master-tip-example {
            font-size: 0.85rem;
            color: var(--text-secondary);
        }
        
        .masters-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(280px, 1fr));
            gap: 1rem;
        }
        
        .master-card {
            padding: 1rem;
            background: var(--bg-tertiary);
            border-radius: 8px;
            border: 1px solid var(--border);
            cursor: pointer;
            transition: all 0.2s;
        }
        
        .master-card:hover {
            border-color: var(--accent);
            background: var(--border);
        }
        
        .master-name {
            font-weight: 600;
            margin-bottom: 0.25rem;
        }
        
        .master-works {
            font-size: 0.85rem;
            color: var(--text-secondary);
            margin-bottom: 0.5rem;
        }
        
        .master-technique {
            font-size: 0.85rem;
            color: var(--accent);
        }
        
        .category-filter {
            display: flex;
            flex-wrap: wrap;
            gap: 0.5rem;
            margin-bottom: 1rem;
        }
        
        .filter-btn {
            padding: 0.5rem 1rem;
            background: var(--bg-tertiary);
            border: 1px solid var(--border);
            border-radius: 20px;
            color: var(--text-secondary);
            cursor: pointer;
            font-size: 0.85rem;
            transition: all 0.2s;
        }
        
        .filter-btn:hover {
            border-color: var(--accent);
        }
        
        .filter-btn.active {
            background: var(--accent);
            border-color: var(--accent);
            color: var(--bg-primary);
        }
        
        .beat-nav {
            display: flex;
            justify-content: space-between;
            margin-top: 1rem;
            padding-top: 1rem;
            border-top: 1px solid var(--border);
        }
        
        .project-setup {
            display: grid;
            gap: 1rem;
        }
        
        .tabs-sub {
            display: flex;
            gap: 0.25rem;
            padding: 0.5rem;
            background: var(--bg-tertiary);
            border-radius: 8px;
            margin-bottom: 1rem;
        }
        
        .tab-sub {
            padding: 0.5rem 1rem;
            background: transparent;
            border: none;
            border-radius: 6px;
            color: var(--text-secondary);
            cursor: pointer;
            font-size: 0.9rem;
            transition: all 0.2s;
        }
        
        .tab-sub:hover {
            background: var(--bg-secondary);
        }
        
        .tab-sub.active {
            background: var(--accent);
            color: var(--bg-primary);
        }
        
        /* Empty state */
        .empty-state {
            text-align: center;
            padding: 3rem 2rem;
            color: var(--text-secondary);
        }
        
        .empty-state i {
            width: 64px;
            height: 64px;
            margin-bottom: 1rem;
            opacity: 0.5;
        }
        
        .empty-state h3 {
            font-size: 1.2rem;
            margin-bottom: 0.5rem;
            color: var(--text-primary);
        }
        
        /* Loading */
        .loading {
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 0.5rem;
            padding: 2rem;
            color: var(--text-secondary);
        }
        
        .spinner {
            width: 20px;
            height: 20px;
            border: 2px solid var(--border);
            border-top-color: var(--accent);
            border-radius: 50%;
            animation: spin 1s linear infinite;
        }
        
        @keyframes spin {
            to { transform: rotate(360deg); }
        }
        
        /* Responsive */
        @media (max-width: 768px) {
            .header {
                padding: 0.75rem 1rem;
            }
            
            .logo h1 {
                font-size: 1.2rem;
            }
            
            .nav-tabs {
                padding: 0.5rem;
            }
            
            .nav-tab {
                padding: 0.5rem 0.75rem;
                font-size: 0.85rem;
            }
            
            .nav-tab span {
                display: none;
            }
            
            .main-content {
                padding: 1rem;
            }
            
            .chat-message {
                max-width: 90%;
            }
        }
        
        /* Scrollbar */
        ::-webkit-scrollbar {
            width: 8px;
            height: 8px;
        }
        
        ::-webkit-scrollbar-track {
            background: var(--bg-primary);
        }
        
        ::-webkit-scrollbar-thumb {
            background: var(--bg-tertiary);
            border-radius: 4px;
        }
        
        ::-webkit-scrollbar-thumb:hover {
            background: var(--border);
        }

        /* Hidden file input */
        .hidden-input {
            display: none;
        }

        /* ========================================
           NEW FEATURES STYLES
           ======================================== */

        /* Scene Builder Styles */
        .scene-builder {
            display: flex;
            flex-direction: column;
            gap: 1.5rem;
        }

        .scene-form {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 1rem;
        }

        .scene-form-full {
            grid-column: 1 / -1;
        }

        .scene-preview {
            background: var(--bg-tertiary);
            border-radius: 8px;
            padding: 1.5rem;
            font-family: 'Courier New', monospace;
            white-space: pre-wrap;
            max-height: 400px;
            overflow-y: auto;
        }

        .scene-preview .scene-heading {
            font-weight: bold;
            color: var(--accent);
            margin-bottom: 1rem;
        }

        .scene-preview .action {
            margin: 0.5rem 0;
        }

        .scene-preview .character-name {
            text-align: center;
            font-weight: bold;
            margin-top: 1rem;
            text-transform: uppercase;
        }

        .scene-preview .dialogue {
            text-align: center;
            max-width: 60%;
            margin: 0 auto;
        }

        .scene-preview .parenthetical {
            text-align: center;
            font-style: italic;
            color: var(--text-secondary);
        }

        /* Dialogue Generator Styles */
        .dialogue-generator {
            display: flex;
            flex-direction: column;
            gap: 1rem;
        }

        .dialogue-options {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 1rem;
        }

        .dialogue-option {
            padding: 1rem;
            background: var(--bg-tertiary);
            border-radius: 8px;
            border: 2px solid var(--border);
            cursor: pointer;
            transition: all 0.2s;
        }

        .dialogue-option:hover {
            border-color: var(--accent);
        }

        .dialogue-option.selected {
            border-color: var(--accent);
            background: rgba(245, 158, 11, 0.1);
        }

        .dialogue-option-label {
            font-weight: 600;
            margin-bottom: 0.5rem;
            color: var(--accent);
        }

        .dialogue-preview {
            background: var(--bg-tertiary);
            border-radius: 8px;
            padding: 1rem;
            font-family: 'Courier New', monospace;
        }

        /* Conflict Escalator Styles */
        .conflict-scale {
            display: flex;
            flex-direction: column;
            gap: 0.5rem;
        }

        .conflict-level {
            display: flex;
            align-items: center;
            gap: 1rem;
            padding: 1rem;
            background: var(--bg-tertiary);
            border-radius: 8px;
            cursor: pointer;
            transition: all 0.2s;
            border-left: 4px solid;
        }

        .conflict-level:hover {
            background: var(--border);
        }

        .conflict-level.level-1 { border-left-color: #22c55e; }
        .conflict-level.level-2 { border-left-color: #84cc16; }
        .conflict-level.level-3 { border-left-color: #f59e0b; }
        .conflict-level.level-4 { border-left-color: #f97316; }
        .conflict-level.level-5 { border-left-color: #ef4444; }

        .conflict-level-number {
            width: 32px;
            height: 32px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: 700;
            color: var(--bg-primary);
        }

        .conflict-level.level-1 .conflict-level-number { background: #22c55e; }
        .conflict-level.level-2 .conflict-level-number { background: #84cc16; }
        .conflict-level.level-3 .conflict-level-number { background: #f59e0b; }
        .conflict-level.level-4 .conflict-level-number { background: #f97316; }
        .conflict-level.level-5 .conflict-level-number { background: #ef4444; }

        .conflict-content {
            flex: 1;
        }

        .conflict-title {
            font-weight: 600;
            margin-bottom: 0.25rem;
        }

        .conflict-description {
            font-size: 0.9rem;
            color: var(--text-secondary);
        }

        /* Plot Twist Generator Styles */
        .twist-categories {
            display: flex;
            flex-wrap: wrap;
            gap: 0.5rem;
            margin-bottom: 1rem;
        }

        .twist-category-btn {
            padding: 0.5rem 1rem;
            background: var(--bg-tertiary);
            border: 1px solid var(--border);
            border-radius: 20px;
            color: var(--text-secondary);
            cursor: pointer;
            font-size: 0.85rem;
            transition: all 0.2s;
        }

        .twist-category-btn:hover {
            border-color: var(--accent);
        }

        .twist-category-btn.active {
            background: var(--accent);
            border-color: var(--accent);
            color: var(--bg-primary);
        }

        .twist-results {
            display: flex;
            flex-direction: column;
            gap: 0.75rem;
        }

        .twist-card {
            padding: 1rem;
            background: var(--bg-tertiary);
            border-radius: 8px;
            border-left: 4px solid var(--accent);
            cursor: pointer;
            transition: all 0.2s;
        }

        .twist-card:hover {
            background: var(--border);
        }

        .twist-title {
            font-weight: 600;
            margin-bottom: 0.5rem;
        }

        .twist-setup {
            font-size: 0.9rem;
            color: var(--text-secondary);
            margin-bottom: 0.5rem;
        }

        .twist-example {
            font-size: 0.85rem;
            font-style: italic;
            color: var(--text-muted);
        }

        /* Export Modal Styles */
        .export-options {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 1rem;
        }

        .export-option {
            padding: 1.5rem;
            background: var(--bg-tertiary);
            border-radius: 8px;
            border: 2px solid var(--border);
            cursor: pointer;
            text-align: center;
            transition: all 0.2s;
        }

        .export-option:hover {
            border-color: var(--accent);
        }

        .export-option i {
            width: 32px;
            height: 32px;
            color: var(--accent);
            margin-bottom: 0.5rem;
        }

        .export-option-title {
            font-weight: 600;
            margin-bottom: 0.25rem;
        }

        .export-option-desc {
            font-size: 0.85rem;
            color: var(--text-secondary);
        }

        /* Master Detail Modal */
        .master-detail-modal {
            max-width: 600px;
        }

        .master-detail-header {
            display: flex;
            align-items: center;
            gap: 1rem;
            margin-bottom: 1rem;
        }

        .master-avatar {
            width: 64px;
            height: 64px;
            background: linear-gradient(135deg, var(--accent), #fbbf24);
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 1.5rem;
        }

        .master-info h2 {
            font-size: 1.25rem;
            margin-bottom: 0.25rem;
        }

        .master-info p {
            color: var(--text-secondary);
            font-size: 0.9rem;
        }

        .master-technique-box {
            background: var(--bg-tertiary);
            border-radius: 8px;
            padding: 1rem;
            margin-bottom: 1rem;
        }

        .master-technique-label {
            font-size: 0.85rem;
            color: var(--accent);
            margin-bottom: 0.5rem;
        }

        .master-quote-box {
            background: linear-gradient(135deg, rgba(245, 158, 11, 0.1), rgba(251, 191, 36, 0.05));
            border: 1px solid rgba(245, 158, 11, 0.3);
            border-radius: 8px;
            padding: 1rem;
            margin-bottom: 1rem;
        }

        .master-quote-box blockquote {
            font-style: italic;
            font-size: 1.1rem;
            margin: 0;
        }

        /* Tool tabs in Writer */
        .tool-tabs {
            display: flex;
            gap: 0.5rem;
            padding: 0.5rem;
            background: var(--bg-tertiary);
            border-radius: 8px;
            margin-bottom: 1rem;
            flex-wrap: wrap;
        }

        .tool-tab {
            padding: 0.5rem 1rem;
            background: transparent;
            border: none;
            border-radius: 6px;
            color: var(--text-secondary);
            cursor: pointer;
            font-size: 0.85rem;
            display: flex;
            align-items: center;
            gap: 0.5rem;
            transition: all 0.2s;
        }

        .tool-tab:hover {
            background: var(--bg-secondary);
        }

        .tool-tab.active {
            background: var(--accent);
            color: var(--bg-primary);
        }

        .tool-tab i {
            width: 16px;
            height: 16px;
        }

        /* Copy button */
        .copy-btn {
            padding: 0.25rem 0.5rem;
            font-size: 0.75rem;
            background: var(--bg-secondary);
            border: 1px solid var(--border);
            border-radius: 4px;
            color: var(--text-secondary);
            cursor: pointer;
            transition: all 0.2s;
        }

        .copy-btn:hover {
            background: var(--accent);
            color: var(--bg-primary);
        }

        .copy-btn.copied {
            background: var(--success);
            color: white;
        }

        /* Tooltip */
        .tooltip {
            position: relative;
        }

        .tooltip::after {
            content: attr(data-tooltip);
            position: absolute;
            bottom: 100%;
            left: 50%;
            transform: translateX(-50%);
            padding: 0.5rem 0.75rem;
            background: var(--bg-primary);
            border: 1px solid var(--border);
            border-radius: 4px;
            font-size: 0.8rem;
            white-space: nowrap;
            opacity: 0;
            visibility: hidden;
            transition: all 0.2s;
            z-index: 10;
        }

        .tooltip:hover::after {
            opacity: 1;
            visibility: visible;
        }

        /* Progress indicator */
        .progress-bar {
            width: 100%;
            height: 8px;
            background: var(--bg-tertiary);
            border-radius: 4px;
            overflow: hidden;
        }

        .progress-fill {
            height: 100%;
            background: linear-gradient(90deg, var(--accent), #fbbf24);
            border-radius: 4px;
            transition: width 0.3s;
        }

        /* Tabs scrollable */
        .tabs-sub {
            overflow-x: auto;
            -webkit-overflow-scrolling: touch;
        }

        /* Animation for new items */
        @keyframes slideIn {
            from {
                opacity: 0;
                transform: translateY(10px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        .animate-in {
            animation: slideIn 0.3s ease-out;
        }
    </style>
</head>
<body>
    <div id="app" class="app-container">
        <!-- App content rendered by JavaScript -->
    </div>

    <script>
    // ============================================
    // STATE MANAGEMENT
    // ============================================
    
    const state = {
        activeTab: 'scripts',
        scripts: [],
        characters: [],
        locations: [],
        selectedScript: null,
        selectedScene: null,
        storyframe: {
            longLine: '',
            genre: 'drama',
            totalWeeks: 10,
            weeks: []
        },
        chat: {
            messages: [],
            isLoading: false
        },
        settings: {
            apiKey: '',
            proxyUrl: 'https://actingtool.ferencsomogyi.workers.dev/v1/messages'
        },
        ui: {
            showSettings: false,
            showSceneViewer: false,
            isProcessing: false,
            showMasterDetail: null,
            showExportModal: false
        },
        // NEW: Writer Assistant State
        writer: {
            subTab: 'beats', // beats, scene, dialogue, conflict, twist
            method: 'savethecat',
            genre: 'thriller',
            logline: '',
            currentBeat: 0,
            beats: {},
            suggestions: [],
            isGenerating: false,
            masterFilter: 'all',
            selectedMaster: null, // ID van geselecteerde meester
            // Scene Builder state
            scene: {
                location: '',
                timeOfDay: 'DAY',
                intExt: 'INT',
                characters: [],
                objective: '',
                conflict: '',
                tone: 'neutral',
                generatedScene: ''
            },
            // Dialogue Generator state
            dialogue: {
                speaker: '',
                listener: '',
                objective: '',
                subtext: '',
                tone: 'neutral',
                options: [],
                selectedOption: null
            },
            // Conflict Escalator state
            conflict: {
                baseConflict: '',
                escalations: [],
                selectedLevel: null
            },
            // Plot Twist state
            twist: {
                category: 'all',
                context: '',
                twists: []
            }
        }
    };

    // Load from localStorage
    function loadState() {
        try {
            const saved = localStorage.getItem('scriptmaster_state');
            if (saved) {
                const parsed = JSON.parse(saved);
                Object.assign(state.scripts, parsed.scripts || []);
                Object.assign(state.settings, parsed.settings || {});
                Object.assign(state.storyframe, parsed.storyframe || {});
                if (parsed.writer) {
                    Object.assign(state.writer, parsed.writer);
                }
                rebuildIndexes();
            }
        } catch (e) {
            console.error('Error loading state:', e);
        }
    }

    // Save to localStorage
    function saveState() {
        try {
            const toSave = {
                scripts: state.scripts,
                settings: state.settings,
                storyframe: state.storyframe,
                writer: state.writer
            };
            localStorage.setItem('scriptmaster_state', JSON.stringify(toSave));
        } catch (e) {
            console.error('Error saving state:', e);
        }
    }

    // Rebuild character and location indexes from scripts
    function rebuildIndexes() {
        const charMap = new Map();
        const locMap = new Map();

        state.scripts.forEach((script, scriptIndex) => {
            script.scenes?.forEach((scene, sceneIndex) => {
                // Locations
                if (scene.location) {
                    const locKey = scene.location.toUpperCase();
                    if (!locMap.has(locKey)) {
                        locMap.set(locKey, {
                            name: scene.location,
                            scenes: [],
                            scripts: new Set()
                        });
                    }
                    locMap.get(locKey).scenes.push({ scriptIndex, sceneIndex, header: scene.header });
                    locMap.get(locKey).scripts.add(script.title);
                }

                // Characters
                scene.characters?.forEach(charName => {
                    const charKey = charName.toUpperCase();
                    if (!charMap.has(charKey)) {
                        charMap.set(charKey, {
                            name: charName,
                            scenes: [],
                            scripts: new Set(),
                            dialogueCount: 0
                        });
                    }
                    charMap.get(charKey).scenes.push({ scriptIndex, sceneIndex });
                    charMap.get(charKey).scripts.add(script.title);
                    charMap.get(charKey).dialogueCount += scene.dialogues?.filter(d => 
                        d.character.toUpperCase() === charKey
                    ).length || 0;
                });
            });
        });

        state.characters = Array.from(charMap.values()).map(c => ({
            ...c,
            scripts: Array.from(c.scripts)
        })).sort((a, b) => b.dialogueCount - a.dialogueCount);

        state.locations = Array.from(locMap.values()).map(l => ({
            ...l,
            scripts: Array.from(l.scripts)
        })).sort((a, b) => b.scenes.length - a.scenes.length);
    }

    // ============================================
    // SCRIPT PARSING
    // ============================================
    
    // Detecteer of een script het GTST/Dutch TV format gebruikt
    function detectGTSTFormat(text) {
        // GTST format indicators:
        // 1. Scene codes like "6931 01 A2 1:20"
        // 2. Numbered dialogue like "1. RIK"
        // 3. Dutch character name patterns
        // 4. Lack of INT./EXT. markers
        
        const lines = text.split('\n').slice(0, 100); // Check first 100 lines
        let gtssIndicators = 0;
        let hollywoodIndicators = 0;
        
        for (const line of lines) {
            const trimmed = line.trim();
            
            // GTST indicators
            if (trimmed.match(/^\d{4}\s+\d+\s+[A-Z]\d?\s+[\d:]+/)) gtssIndicators += 3;
            if (trimmed.match(/^\d+\.\s*[A-Z]+/)) gtssIndicators += 2;
            if (trimmed.match(/^SC\.?\s*\d+/i)) gtssIndicators += 1;
            
            // Hollywood indicators
            if (trimmed.match(/^(INT\.|EXT\.)/i)) hollywoodIndicators += 3;
            if (trimmed.match(/^FADE (IN|OUT)/i)) hollywoodIndicators += 1;
            if (trimmed.match(/^CUT TO:/i)) hollywoodIndicators += 1;
        }
        
        console.log(`Format detection - GTST: ${gtssIndicators}, Hollywood: ${hollywoodIndicators}`);
        return gtssIndicators > hollywoodIndicators;
    }

    function parseScript(text, filename) {
        const lines = text.split('\n');
        const scenes = [];
        const characters = new Set();
        const locations = new Set();
        
        let currentScene = null;
        let sceneNumber = 0;
        let lastCharacter = null;
        let isDialogue = false;
        
        // Detecteer script format
        const isGTSTFormat = detectGTSTFormat(text);
        console.log('Script format detected:', isGTSTFormat ? 'GTST/Dutch TV' : 'Standard Hollywood');

        for (let i = 0; i < lines.length; i++) {
            const line = lines[i];
            const trimmed = line.trim();
            
            // === SCENE HEADER DETECTION ===
            
            // Standard Hollywood format: INT./EXT. LOCATION - TIME
            const standardMatch = trimmed.match(/^(INT\.|EXT\.|INT\/EXT\.|I\/E\.)/i);
            
            // GTST format: "6931 01 A2 1:20 FLAT / RIK & SHANTI" of "SC 1 INT FLAT - DAY"
            // Pattern: episode scene_code timing LOCATION / CHARACTERS
            const gtssMatch = trimmed.match(/^(\d{4}\s+\d+\s+[A-Z]\d?\s+[\d:]+\s+)(.+)/);
            // Also match simpler Dutch TV format: "SC 1" or "SCENE 1" or just "1."
            const simpleSceneMatch = trimmed.match(/^(SC\.?\s*\d+|SCENE\s*\d+|SCÃˆNE\s*\d+|\d+\.)\s*(.*)$/i);
            // Match location lines that come after GTST headers (all caps with /)
            const locationLineMatch = isGTSTFormat && !gtssMatch && !standardMatch && 
                trimmed.match(/^[A-Z\s\/]+$/) && trimmed.includes('/') && trimmed.length > 5 && trimmed.length < 60;
            
            if (standardMatch || gtssMatch || simpleSceneMatch) {
                if (currentScene) {
                    scenes.push(currentScene);
                }
                sceneNumber++;
                
                let locationPart = '';
                let timePart = '';
                let header = trimmed;
                
                if (standardMatch) {
                    // Standard Hollywood parsing
                    const headerParts = trimmed.split('-');
                    locationPart = headerParts[0].replace(/^(INT\.|EXT\.|INT\/EXT\.|I\/E\.)\s*/i, '').trim();
                    timePart = headerParts[1]?.trim() || '';
                } else if (gtssMatch) {
                    // GTST format: extract location after the codes
                    const afterCodes = gtssMatch[2];
                    // Split on " / " to separate location from characters
                    const parts = afterCodes.split(/\s*\/\s*/);
                    locationPart = parts[0]?.trim() || afterCodes;
                    // Characters might be in the second part
                    if (parts[1]) {
                        // Pre-add characters mentioned in header
                        const headerChars = parts[1].split(/\s*[&,]\s*/);
                        headerChars.forEach(c => {
                            const cleanName = c.trim().toUpperCase();
                            if (cleanName.length >= 2) characters.add(cleanName);
                        });
                    }
                } else if (simpleSceneMatch) {
                    // Simple scene number format
                    locationPart = simpleSceneMatch[2]?.trim() || `Scene ${sceneNumber}`;
                }
                
                locations.add(locationPart);
                
                currentScene = {
                    number: sceneNumber,
                    header: header,
                    location: locationPart,
                    time: timePart,
                    characters: [],
                    dialogues: [],
                    content: [trimmed]
                };
                lastCharacter = null;
                isDialogue = false;
                continue;
            }

            if (!currentScene) continue;

            // === CHARACTER NAME DETECTION ===
            
            // GTST numbered dialogue format: "1. RIK" or "2. SHANTI"
            const numberedCharMatch = trimmed.match(/^(\d+)\.\s*([A-Z][A-Z\s\.\']+)$/);
            if (numberedCharMatch) {
                const charName = numberedCharMatch[2].trim();
                characters.add(charName);
                if (!currentScene.characters.includes(charName)) {
                    currentScene.characters.push(charName);
                }
                lastCharacter = charName;
                isDialogue = true;
                currentScene.content.push(line);
                continue;
            }
            
            // Dutch TV character format: "RIK DE JONG" on its own line (full name, all caps)
            // These are often character introductions in scene descriptions
            const dutchCharMatch = trimmed.match(/^([A-Z][A-Z\s]+)$/);
            if (dutchCharMatch && trimmed.length >= 3 && trimmed.length < 30 &&
                !trimmed.match(/^(INT|EXT|FADE|CUT|DISSOLVE|THE END|CONTINUED|LATER|DAG|NACHT|AVOND|OCHTEND)$/i)) {
                const charName = dutchCharMatch[1].trim();
                characters.add(charName);
                if (!currentScene.characters.includes(charName)) {
                    currentScene.characters.push(charName);
                }
                // Don't set as lastCharacter here - these are often scene introductions, not dialogue
                currentScene.content.push(line);
                continue;
            }

            // Standard Hollywood character format (ALL CAPS, possibly with parenthetical)
            const charMatch = trimmed.match(/^([A-Z][A-Z\s\.\']+)(\s*\([^)]+\))?$/);
            if (charMatch && trimmed.length > 1 && trimmed.length < 40 && 
                !trimmed.match(/^(INT\.|EXT\.|FADE|CUT|DISSOLVE|THE END)/i)) {
                const charName = charMatch[1].trim();
                
                // Validate it's likely a character name
                if (charName.length >= 2 && !charName.match(/^\d/) && 
                    !charName.match(/^(CONTINUED|CONT'D|MORE|LATER|ANGLE|CLOSE|WIDE|POV)$/i)) {
                    characters.add(charName);
                    if (!currentScene.characters.includes(charName)) {
                        currentScene.characters.push(charName);
                    }
                    lastCharacter = charName;
                    isDialogue = true;
                    currentScene.content.push(line);
                    continue;
                }
            }

            // Dialogue (follows a character name, often centered or indented)
            if (isDialogue && trimmed && lastCharacter) {
                // Check if it's a parenthetical
                if (trimmed.match(/^\([^)]+\)$/)) {
                    currentScene.dialogues.push({
                        character: lastCharacter,
                        type: 'parenthetical',
                        text: trimmed
                    });
                } else if (!trimmed.match(/^([A-Z][A-Z\s\.\']+)$/)) {
                    // It's dialogue text
                    currentScene.dialogues.push({
                        character: lastCharacter,
                        type: 'dialogue',
                        text: trimmed
                    });
                }
                currentScene.content.push(line);
                continue;
            }

            // Action line
            if (trimmed) {
                isDialogue = false;
                lastCharacter = null;
                currentScene.content.push(line);
            }
        }

        // Don't forget the last scene
        if (currentScene) {
            scenes.push(currentScene);
        }
        
        // FALLBACK: Als geen scenes gevonden, maak 1 scene van hele tekst
        if (scenes.length === 0 && text.trim().length > 0) {
            console.warn('No scenes detected - creating fallback scene from raw text');
            
            // Probeer nog karakters te vinden via een simpelere methode
            const capsWords = text.match(/\b([A-Z]{2,}(?:\s+[A-Z]{2,})?)\b/g) || [];
            const potentialChars = capsWords.filter(w => 
                w.length >= 3 && 
                w.length < 25 &&
                !w.match(/^(INT|EXT|DAG|NACHT|LATER|AVOND|OCHTEND|SCENE|THE|END|FADE|CUT)$/i)
            );
            // Dedupe and limit
            const uniqueChars = [...new Set(potentialChars)].slice(0, 10);
            uniqueChars.forEach(c => characters.add(c));
            
            scenes.push({
                number: 1,
                header: 'SCRIPT (geen scenes gedetecteerd)',
                location: 'Onbekend',
                time: '',
                characters: uniqueChars,
                dialogues: [],
                content: text.split('\n').filter(l => l.trim())
            });
            
            locations.add('Onbekend');
        }

        console.log(`Parsing complete: ${scenes.length} scenes, ${characters.size} characters, ${locations.size} locations`);

        return {
            title: filename.replace(/\.(txt|fountain|fdx|pdf|docx)$/i, ''),
            filename: filename,
            uploadedAt: new Date().toISOString(),
            scenes: scenes,
            characters: Array.from(characters),
            locations: Array.from(locations),
            rawText: text,
            stats: {
                sceneCount: scenes.length,
                characterCount: characters.size,
                locationCount: locations.size,
                dialogueCount: scenes.reduce((sum, s) => sum + s.dialogues.length, 0),
                wordCount: text.split(/\s+/).length
            }
        };
    }

    // Extract text from PDF using PDF.js
    async function extractTextFromPDF(arrayBuffer) {
        const pdf = await pdfjsLib.getDocument({ data: arrayBuffer }).promise;
        let fullText = '';
        
        for (let i = 1; i <= pdf.numPages; i++) {
            const page = await pdf.getPage(i);
            const content = await page.getTextContent();
            
            // Betere text reconstructie met newlines
            let lastY = null;
            let pageText = '';
            
            for (const item of content.items) {
                // Check of we naar een nieuwe regel moeten
                if (lastY !== null && Math.abs(item.transform[5] - lastY) > 5) {
                    pageText += '\n';
                }
                pageText += item.str;
                lastY = item.transform[5];
            }
            
            fullText += pageText + '\n\n';
        }
        
        return fullText;
    }

    // Extract text from DOCX using Mammoth
    async function extractTextFromDOCX(arrayBuffer) {
        const result = await mammoth.extractRawText({ arrayBuffer });
        // Zorg voor proper newline formatting
        let text = result.value;
        
        // Hollywood format: voeg newlines toe voor INT./EXT.
        text = text.replace(/\s+(INT\.|EXT\.)/gi, '\n\n$1');
        
        // GTST format: voeg newlines toe voor scene codes (bijv. "6931 01 A2")
        text = text.replace(/\s+(\d{4}\s+\d+\s+[A-Z]\d?\s+[\d:]+)/g, '\n\n$1');
        
        // Voeg newlines toe voor genummerde dialogen (bijv. "1. RIK")
        text = text.replace(/\s+(\d+\.\s+[A-Z]{2,})/g, '\n$1');
        
        // 3+ spaties â†’ newline (vaak gebruikt als scheidingsteken)
        text = text.replace(/\s{3,}/g, '\n');
        
        return text;
    }

    // Process uploaded file
    async function processFile(file) {
        const ext = file.name.split('.').pop().toLowerCase();
        let text = '';

        try {
            if (ext === 'txt' || ext === 'fountain') {
                text = await file.text();
            } else if (ext === 'pdf') {
                const arrayBuffer = await file.arrayBuffer();
                text = await extractTextFromPDF(arrayBuffer);
            } else if (ext === 'docx') {
                const arrayBuffer = await file.arrayBuffer();
                text = await extractTextFromDOCX(arrayBuffer);
            } else {
                throw new Error(`Unsupported file type: ${ext}`);
            }

            // Debug: log extracted text length
            console.log(`Extracted ${text.length} characters from ${file.name}`);
            console.log('First 500 chars:', text.substring(0, 500));

            const script = parseScript(text, file.name);
            
            state.scripts.push(script);
            rebuildIndexes();
            saveState();
            return script;
        } catch (error) {
            console.error('Error processing file:', error);
            throw error;
        }
    }

    // ============================================
    // STORYFRAME GENERATION
    // ============================================

    const genres = {
        drama: { 
            name: 'Psychologisch Drama', 
            color: '#3b82f6',
            principles: 'Focus op interne conflicten, morele dilemma\'s, langzame onthullingen van geheimen, complexe karakterpsychologie en emotionele confrontaties.',
            references: ['Big Little Lies', 'The Affair', 'In Treatment', 'Mare of Easttown', 'Normal People'],
            tips: 'Laat karakters hun eigen grootste vijand zijn. Subtext is belangrijker dan dialoog.'
        },
        ya: { 
            name: 'Young Adult', 
            color: '#ec4899',
            principles: 'Coming-of-age thema\'s, identiteitsvorming, eerste ervaringen (liefde, verlies, verraad), sociale dynamiek en groepsdruk.',
            references: ['Euphoria', 'Skins', 'Skam', 'Sex Education', 'Elite'],
            tips: 'Authenticiteit is alles. Vermijd moraliseren. Laat jongeren zelf hun fouten maken en ervan leren.'
        },
        romcom: { 
            name: 'Romantic Comedy', 
            color: '#f43f5e',
            principles: 'Will-they-won\'t-they dynamiek, miscommunicatie, grappige obstakels, groeicurve naar kwetsbaarheid en commitment.',
            references: ['You\'re the Worst', 'Crazy Ex-Girlfriend', 'Fleabag', 'Love', 'The Mindy Project'],
            tips: 'De beste romcoms hebben twee karakters die allebei fout zitten. Timing is alles - bijna-kusjes zijn spannender dan echte kusjes.'
        },
        thriller: { 
            name: 'Suspense/Thriller', 
            color: '#ef4444',
            principles: 'Escalerende spanning, ticking clock elementen, morele degradatie, cat-and-mouse dynamiek, verrassende wendingen.',
            references: ['Breaking Bad', 'The Fall', 'Mindhunter', 'Ozark', 'Broadchurch'],
            tips: 'Geef de kijker meer informatie dan de karakters (dramatic irony). Laat spanning komen uit wat NIET gezegd wordt.'
        },
        family: { 
            name: 'Family Drama', 
            color: '#22c55e',
            principles: 'Generatieconflicten, erfeniskwesties, familiegeheimen, loyaliteit versus eigenheid, de kracht en pijn van bloedverwanten.',
            references: ['Succession', 'This Is Us', 'Parenthood', 'Six Feet Under', 'Transparent'],
            tips: 'Elke familiebijeenkomst is een slagveld met onzichtbare wapens. De diepste wonden komen van degenen die het dichtst bij ons staan.'
        },
        social: { 
            name: 'Social Realism', 
            color: '#8b5cf6',
            principles: 'Maatschappelijke thema\'s, klassenverschillen, systemisch onrecht, alledaagse heroÃ¯ek, authentieke representatie.',
            references: ['The Wire', 'Shameless', 'I May Destroy You', 'When They See Us', 'Top Boy'],
            tips: 'Vermijd "poverty porn". Geef karakters agency. Laat zien hoe systemen mensen beÃ¯nvloeden zonder karakters te reduceren tot slachtoffers.'
        }
    };

    const actStructure = [
        { 
            act: 1, 
            name: 'Exposition', 
            description: 'Setup, karakters introduceren, status quo',
            detail: 'Introduceer de wereld, de belangrijkste karakters en hun normale leven. Hint naar het conflict dat komt. Eindig met de "inciting incident" die alles in beweging zet.',
            percentage: 20
        },
        { 
            act: 2, 
            name: 'Rising Action', 
            description: 'Conflict escaleert, stakes verhogen',
            detail: 'Het conflict wordt duidelijk en groeit. Karakters proberen het probleem op te lossen maar maken het vaak erger. Introduceer subplots. De stakes worden persoonlijker.',
            percentage: 25
        },
        { 
            act: 3, 
            name: 'Mid-Act Climax', 
            description: 'Keerpunt, grote onthulling of confrontatie',
            detail: 'Het "point of no return". Een grote onthulling, verraad of confrontatie verandert alles. Karakters kunnen niet meer terug naar hoe het was.',
            percentage: 15
        },
        { 
            act: 4, 
            name: 'Falling Action', 
            description: 'Gevolgen, dieper conflict, karaktergroei',
            detail: 'De gevolgen van de mid-act climax. Karakters worden gedwongen te veranderen of te falen. Het "darkest moment" waar alles verloren lijkt.',
            percentage: 25
        },
        { 
            act: 5, 
            name: 'Resolution', 
            description: 'Climax en afronding',
            detail: 'De finale confrontatie. Karakters gebruiken wat ze geleerd hebben. Niet alles hoeft perfect af te lopen - bittersweet is vaak sterker.',
            percentage: 15
        }
    ];

    function getActForWeek(weekNum, totalWeeks) {
        // Bereken dynamisch welke act bij welke week hoort op basis van percentages
        const week1Based = weekNum; // 1-indexed
        const progress = (week1Based / totalWeeks) * 100;
        
        let cumulative = 0;
        for (const act of actStructure) {
            cumulative += act.percentage;
            if (progress <= cumulative) {
                return act;
            }
        }
        return actStructure[actStructure.length - 1];
    }
    
    function getWeekRangeForAct(actNum, totalWeeks) {
        // Bereken welke weken bij een act horen
        let startPercent = 0;
        for (let i = 0; i < actNum - 1; i++) {
            startPercent += actStructure[i].percentage;
        }
        const endPercent = startPercent + actStructure[actNum - 1].percentage;
        
        const startWeek = Math.ceil((startPercent / 100) * totalWeeks) || 1;
        const endWeek = Math.ceil((endPercent / 100) * totalWeeks);
        
        return { start: startWeek, end: endWeek };
    }

    async function generateStoryframe() {
        if (!state.settings.apiKey || !state.storyframe.longLine) {
            alert('Vul eerst je API key in (Settings) en een lange lijn.');
            return;
        }

        state.ui.isProcessing = true;
        render();

        const genreInfo = genres[state.storyframe.genre];
        const totalWeeks = state.storyframe.totalWeeks;
        
        // Bereken week ranges per act
        const actWeekRanges = actStructure.map((act, i) => {
            const range = getWeekRangeForAct(i + 1, totalWeeks);
            return `- Week ${range.start}${range.end > range.start ? '-' + range.end : ''}: Act ${act.act} (${act.name}) - ${act.detail}`;
        }).join('\n');
        
        const prompt = `Je bent een ervaren TV-schrijver en creative producer, gespecialiseerd in ${genreInfo.name}. 
Je taak is om een lange lijn om te zetten naar een gestructureerd storyframe dat schrijvers kunnen gebruiken als inspiratiebron VOORDAT ze de synopsis bedenken.

BELANGRIJK: Antwoord VOLLEDIG in het NEDERLANDS.
${getMasterPromptText()}

=== LANGE LIJN ===
${state.storyframe.longLine}

=== GENRE: ${genreInfo.name.toUpperCase()} ===
**Principes van dit genre:**
${genreInfo.principles}

**Referentie series/films voor dit genre:**
${genreInfo.references.join(', ')}

**Tip voor dit genre:**
${genreInfo.tips}

=== DRAMATISCHE STRUCTUUR (5 ACTES) ===
Verdeel dit verhaal in ${totalWeeks} weken volgens de 5-acten structuur:
${actWeekRanges}

=== INSTRUCTIES ===
Denk als een ervaren ${genreInfo.name} schrijver. Pas de principes van het genre toe. 
Verwijs waar mogelijk naar technieken uit de referentie-series.

Per week geef IN HET NEDERLANDS:
1. **Samenvatting** (2-3 zinnen over wat er gebeurt)
2. **Key beats** (3-4 concrete verhaalbeats/scenes)
3. **Emotionele lading** (welk gevoel moet de kijker hebben aan het eind van deze week)
4. **Genre-element** (welk specifiek ${genreInfo.name} principe pas je hier toe)

=== OUTPUT FORMAT ===
Antwoord in JSON formaat, ALLES IN HET NEDERLANDS:
{
  "weeks": [
    {
      "number": 1,
      "act": 1,
      "actName": "Exposition",
      "summary": "Samenvatting van week 1...",
      "beats": ["Beat 1", "Beat 2", "Beat 3"],
      "emotion": "De emotie die de kijker voelt...",
      "genreElement": "Welk ${genreInfo.name} principe je toepast..."
    }
  ],
  "overallNotes": "Algemene dramaturgische tips voor dit specifieke verhaal..."
}`;

        try {
            const response = await callClaudeAPI(prompt);
            
            // Parse JSON from response
            const jsonMatch = response.match(/\{[\s\S]*\}/);
            if (jsonMatch) {
                const data = JSON.parse(jsonMatch[0]);
                state.storyframe.weeks = data.weeks;
                state.storyframe.notes = data.overallNotes || '';
                saveState();
            }
        } catch (error) {
            console.error('Error generating storyframe:', error);
            alert('Fout bij genereren: ' + error.message);
        }

        state.ui.isProcessing = false;
        render();
    }

    // ============================================
    // AI CHAT
    // ============================================

    async function callClaudeAPI(prompt) {
        const response = await fetch(state.settings.proxyUrl, {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'x-api-key': state.settings.apiKey
            },
            body: JSON.stringify({
                model: 'claude-sonnet-4-20250514',
                max_tokens: 4096,
                messages: [{ role: 'user', content: prompt }]
            })
        });

        if (!response.ok) {
            const error = await response.text();
            throw new Error(`API Error ${response.status}: ${error}`);
        }

        const data = await response.json();
        return data.content[0].text;
    }

    async function sendChatMessage(message) {
        if (!message.trim() || !state.settings.apiKey) {
            if (!state.settings.apiKey) {
                alert('Vul eerst je API key in via Settings.');
            }
            return;
        }

        state.chat.messages.push({ role: 'user', content: message });
        state.chat.isLoading = true;
        render();

        // Build context from scripts
        let context = 'Je bent een AI schrijfassistent voor ScriptMaster Pro. Je helpt scenarioschrijvers met hun werk.\n\n';
        
        if (state.scripts.length > 0) {
            context += 'BESCHIKBARE SCRIPTS:\n';
            state.scripts.forEach(script => {
                context += `- "${script.title}": ${script.stats.sceneCount} scenes, ${script.stats.characterCount} karakters\n`;
                context += `  Karakters: ${script.characters.slice(0, 10).join(', ')}\n`;
                context += `  Locaties: ${script.locations.slice(0, 10).join(', ')}\n`;
            });
            context += '\n';
        }

        if (state.storyframe.longLine) {
            context += `LANGE LIJN: ${state.storyframe.longLine}\n\n`;
        }

        const prompt = context + 'VRAAG VAN DE SCHRIJVER:\n' + message;

        try {
            const response = await callClaudeAPI(prompt);
            state.chat.messages.push({ role: 'assistant', content: response });
        } catch (error) {
            console.error('Chat error:', error);
            state.chat.messages.push({ 
                role: 'assistant', 
                content: `Fout: ${error.message}. Check je API key in Settings.` 
            });
        }

        state.chat.isLoading = false;
        render();
    }

    // ============================================
    // CONTINUITY CHECK
    // ============================================

    function checkContinuity() {
        const issues = [];

        // Check for character name inconsistencies
        const charVariations = new Map();
        state.characters.forEach(char => {
            const base = char.name.split(' ')[0].toUpperCase();
            if (!charVariations.has(base)) {
                charVariations.set(base, []);
            }
            charVariations.get(base).push(char.name);
        });

        charVariations.forEach((variations, base) => {
            if (variations.length > 1) {
                issues.push({
                    type: 'warning',
                    category: 'Karakter',
                    message: `Mogelijke naamvariaties gevonden: ${variations.join(', ')}`,
                    suggestion: 'Check of dit dezelfde persoon is of verschillende karakters.'
                });
            }
        });

        // Check for location inconsistencies
        const locVariations = new Map();
        state.locations.forEach(loc => {
            const simplified = loc.name.replace(/[^a-zA-Z]/g, '').toUpperCase();
            if (!locVariations.has(simplified)) {
                locVariations.set(simplified, []);
            }
            locVariations.get(simplified).push(loc.name);
        });

        locVariations.forEach((variations, base) => {
            if (variations.length > 1) {
                issues.push({
                    type: 'warning',
                    category: 'Locatie',
                    message: `Mogelijke locatievariaties: ${variations.join(', ')}`,
                    suggestion: 'Gebruik consistente locatienamen.'
                });
            }
        });

        // Add success message if no issues
        if (issues.length === 0) {
            issues.push({
                type: 'ok',
                category: 'Algemeen',
                message: 'Geen continuÃ¯teitsproblemen gevonden!',
                suggestion: 'Alles ziet er consistent uit.'
            });
        }

        return issues;
    }

    // ============================================
    // MASTER WISDOM
    // ============================================

    const masterWisdom = {
        structure: [
            { writer: 'Robert McKee', wisdom: 'Story is about change. Each scene must turn the situation in a new direction.' },
            { writer: 'Syd Field', wisdom: 'Plot Point 1 should happen around page 25-27. It spins the story in a new direction.' },
            { writer: 'Blake Snyder', wisdom: 'Your "Save the Cat" moment must happen in the first 10 minutes - make us like the hero.' },
            { writer: 'Christopher Nolan', wisdom: 'Non-linear structure works when each timeline has its own momentum and stakes.' }
        ],
        character: [
            { writer: 'Aaron Sorkin', wisdom: 'Characters are defined by what they DO, not what they say about themselves.' },
            { writer: 'Phoebe Waller-Bridge', wisdom: 'Give characters contradictions. The most interesting people are at war with themselves.' },
            { writer: 'Quentin Tarantino', wisdom: 'A character introduction is a promise to the audience about who this person will be.' },
            { writer: 'Greta Gerwig', wisdom: 'Small moments reveal character more than grand gestures. Watch how they eat, walk, wait.' }
        ],
        dialogue: [
            { writer: 'David Mamet', wisdom: 'People rarely say what they mean. The truth is in what they\'re NOT saying.' },
            { writer: 'Diablo Cody', wisdom: 'Every character needs their own vocabulary. No two people speak exactly alike.' },
            { writer: 'Nora Ephron', wisdom: 'Dialogue should be composed like music - rhythm, pauses, tempo all matter.' },
            { writer: 'Armando Iannucci', wisdom: 'Comedy timing lives in the pauses. The silence after a line can be funnier than the line.' }
        ],
        theme: [
            { writer: 'Charlie Kaufman', wisdom: 'Your theme is a question, not an answer. Let the audience find their own meaning.' },
            { writer: 'Denis Villeneuve', wisdom: 'Every visual choice should reflect the internal state of your characters.' },
            { writer: 'Jordan Peele', wisdom: 'Genre is a vessel for saying something real. Horror can be the most honest form of social commentary.' },
            { writer: 'Bong Joon-ho', wisdom: 'Genre mixing works when you commit fully to each genre within its moments.' }
        ]
    };

    // ============================================
    // WRITING METHODS DATA
    // ============================================

    const writingMethods = {
        savethecat: {
            name: 'Save the Cat',
            author: 'Blake Snyder',
            beats: [
                { id: 1, name: 'Opening Image', page: '1', description: 'De eerste visuele van je film. Zet de toon en geeft een "voor" beeld van je held.' },
                { id: 2, name: 'Theme Stated', page: '5', description: 'Een secundair karakter spreekt het thema uit, vaak terloops.' },
                { id: 3, name: 'Set-up', page: '1-10', description: 'Toon de held\'s gewone wereld en de "Six Things That Need Fixing".' },
                { id: 4, name: 'Catalyst', page: '12', description: 'Het inciting incident dat alles verandert.' },
                { id: 5, name: 'Debate', page: '12-25', description: 'De held twijfelt. Moeten ze wel gaan?' },
                { id: 6, name: 'Break into Two', page: '25', description: 'De held maakt een actieve keuze. Act 2 begint.' },
                { id: 7, name: 'B Story', page: '30', description: 'Een subplot begint, vaak een liefdesverhaal.' },
                { id: 8, name: 'Fun and Games', page: '30-55', description: 'De "promise of the premise" - de fun stuff.' },
                { id: 9, name: 'Midpoint', page: '55', description: 'False victory of false defeat. Stakes worden verhoogd.' },
                { id: 10, name: 'Bad Guys Close In', page: '55-75', description: 'Externe druk neemt toe, alles begint te ontrafelen.' },
                { id: 11, name: 'All Is Lost', page: '75', description: 'Het laagste punt. Vaak een "whiff of death".' },
                { id: 12, name: 'Dark Night of the Soul', page: '75-85', description: 'De held in hopeloosheid, vindt dan kracht.' },
                { id: 13, name: 'Break into Three', page: '85', description: 'A en B verhaallijnen komen samen. Epifanie.' },
                { id: 14, name: 'Finale', page: '85-110', description: 'De held past geleerde lessen toe en wint.' },
                { id: 15, name: 'Final Image', page: '110', description: 'Tegenovergestelde van Opening Image. Transformatie compleet.' }
            ]
        },
        storycircle: {
            name: 'Story Circle',
            author: 'Dan Harmon',
            beats: [
                { id: 1, name: 'YOU', page: '1-10', description: 'Karakter in comfort zone, gewone wereld.' },
                { id: 2, name: 'NEED', page: '10-15', description: 'Ze willen of missen iets.' },
                { id: 3, name: 'GO', page: '15-30', description: 'Ze betreden een onbekende situatie.' },
                { id: 4, name: 'SEARCH', page: '30-50', description: 'Ze passen zich aan en zoeken.' },
                { id: 5, name: 'FIND', page: '50-60', description: 'Ze vinden wat ze zochten (false victory).' },
                { id: 6, name: 'TAKE', page: '60-75', description: 'Ze betalen een zware prijs.' },
                { id: 7, name: 'RETURN', page: '75-90', description: 'Ze keren terug naar hun wereld.' },
                { id: 8, name: 'CHANGE', page: '90-110', description: 'Ze zijn veranderd door de reis.' }
            ]
        },
        threeact: {
            name: '3-Act Structure',
            author: 'Syd Field',
            beats: [
                { id: 1, name: 'Act 1: Setup', page: '1-30', description: 'Introduceer held, wereld, en probleem.' },
                { id: 2, name: 'Inciting Incident', page: '10-15', description: 'Het moment dat alles in gang zet.' },
                { id: 3, name: 'Plot Point 1', page: '25-30', description: 'Keerpunt dat held Act 2 in dwingt.' },
                { id: 4, name: 'Act 2A: Confrontation', page: '30-55', description: 'Held reageert op obstakels.' },
                { id: 5, name: 'Midpoint', page: '55-60', description: 'Grote shift, held wordt proactief.' },
                { id: 6, name: 'Act 2B: Complications', page: '60-85', description: 'Stakes hoger, alles gaat mis.' },
                { id: 7, name: 'Plot Point 2', page: '85-90', description: 'Laagste punt, dan doorbraak.' },
                { id: 8, name: 'Act 3: Resolution', page: '90-120', description: 'Climax en afronding.' }
            ]
        },
        herosjourney: {
            name: 'Hero\'s Journey',
            author: 'Joseph Campbell',
            beats: [
                { id: 1, name: 'Ordinary World', page: '1-10', description: 'De held in hun dagelijks leven.' },
                { id: 2, name: 'Call to Adventure', page: '10-15', description: 'Een uitdaging presenteert zich.' },
                { id: 3, name: 'Refusal of the Call', page: '15-20', description: 'De held aarzelt.' },
                { id: 4, name: 'Meeting the Mentor', page: '20-25', description: 'Een wijze figuur helpt.' },
                { id: 5, name: 'Crossing Threshold', page: '25-30', description: 'De held betreedt de speciale wereld.' },
                { id: 6, name: 'Tests, Allies, Enemies', page: '30-55', description: 'De held wordt getest.' },
                { id: 7, name: 'Approach to Cave', page: '55-65', description: 'Naderen van grootste uitdaging.' },
                { id: 8, name: 'Ordeal', page: '65-75', description: 'Confrontatie met grootste angst.' },
                { id: 9, name: 'Reward', page: '75-80', description: 'De held verkrijgt wat ze zochten.' },
                { id: 10, name: 'The Road Back', page: '80-90', description: 'Begin van de terugkeer.' },
                { id: 11, name: 'Resurrection', page: '90-105', description: 'De ultieme test.' },
                { id: 12, name: 'Return with Elixir', page: '105-120', description: 'Terugkeer, getransformeerd.' }
            ]
        }
    };

    // ============================================
    // 100 MASTER WRITERS DATABASE
    // ============================================

    const masterWriters = [
        // STRUCTURE (1-10)
        { id: 1, name: 'Robert McKee', category: 'structure', works: 'Story (boek)', technique: 'Scene als story event', tip: 'Elke scene moet de waarde van het leven veranderen.' },
        { id: 2, name: 'Syd Field', category: 'structure', works: 'Screenplay', technique: '3-Act Paradigm', tip: 'Structure is the spine of the story.' },
        { id: 3, name: 'Blake Snyder', category: 'structure', works: 'Save the Cat', technique: '15 Beat Sheet', tip: 'Give me the same thing, only different.' },
        { id: 4, name: 'Christopher Nolan', category: 'structure', works: 'Memento, Inception', technique: 'Non-lineaire structuur', tip: 'Play with time to create meaning.' },
        { id: 5, name: 'Quentin Tarantino', category: 'structure', works: 'Pulp Fiction, Kill Bill', technique: 'Chaptered, non-lineair', tip: 'Start in the middle of action.' },
        { id: 6, name: 'Charlie Kaufman', category: 'structure', works: 'Eternal Sunshine', technique: 'Meta-structuur', tip: 'Structure should reflect the theme.' },
        { id: 7, name: 'Christopher McQuarrie', category: 'structure', works: 'Usual Suspects', technique: 'Twist endings', tip: 'Plant seeds early, harvest late.' },
        { id: 8, name: 'David Fincher', category: 'structure', works: 'Fight Club, Gone Girl', technique: 'Unreliable narrator', tip: 'Make the audience complicit.' },
        { id: 9, name: 'Denis Villeneuve', category: 'structure', works: 'Arrival, Blade Runner 2049', technique: 'Slow burn revelation', tip: 'Patience in storytelling pays off.' },
        { id: 10, name: 'Guillermo del Toro', category: 'structure', works: 'Pan\'s Labyrinth', technique: 'Parallelle verhaallijnen', tip: 'Fairy tale structure for adult themes.' },
        
        // CHARACTER (11-25)
        { id: 11, name: 'Aaron Sorkin', category: 'character', works: 'Social Network, West Wing', technique: 'Walk-and-talk', tip: 'Characters are what they DO.' },
        { id: 12, name: 'Phoebe Waller-Bridge', category: 'character', works: 'Fleabag, Killing Eve', technique: 'Breaking fourth wall', tip: 'Give characters contradictions.' },
        { id: 13, name: 'Greta Gerwig', category: 'character', works: 'Lady Bird, Little Women', technique: 'Small moments', tip: 'The specific is universal.' },
        { id: 14, name: 'Jordan Peele', category: 'character', works: 'Get Out, Us', technique: 'Subverted expectations', tip: 'Genre as social commentary.' },
        { id: 15, name: 'Bong Joon-ho', category: 'character', works: 'Parasite', technique: 'Class dynamics', tip: 'Environment shapes character.' },
        { id: 16, name: 'Taika Waititi', category: 'character', works: 'Jojo Rabbit', technique: 'Comedy + tragedy', tip: 'Find the funny in the dark.' },
        { id: 17, name: 'Emerald Fennell', category: 'character', works: 'Promising Young Woman', technique: 'Revenge with purpose', tip: 'Subvert the victim narrative.' },
        { id: 18, name: 'Barry Jenkins', category: 'character', works: 'Moonlight', technique: 'Intimate study', tip: 'Silence speaks volumes.' },
        { id: 19, name: 'Celine Sciamma', category: 'character', works: 'Portrait of a Lady on Fire', technique: 'The gaze', tip: 'Show don\'t tell - especially love.' },
        { id: 20, name: 'Sofia Coppola', category: 'character', works: 'Lost in Translation', technique: 'Mood over plot', tip: 'Atmosphere is character.' },
        { id: 21, name: 'Yorgos Lanthimos', category: 'character', works: 'The Favourite', technique: 'Absurdist drama', tip: 'Alienation as technique.' },
        { id: 22, name: 'Paul Thomas Anderson', category: 'character', works: 'There Will Be Blood', technique: 'Long takes', tip: 'Let scenes breathe.' },
        { id: 23, name: 'Darren Aronofsky', category: 'character', works: 'Black Swan', technique: 'Physical transformation', tip: 'The body shows inner turmoil.' },
        { id: 24, name: 'Mike Leigh', category: 'character', works: 'Secrets & Lies', technique: 'Improvised realism', tip: 'Character from rehearsal.' },
        { id: 25, name: 'Kenneth Lonergan', category: 'character', works: 'Manchester by the Sea', technique: 'Grief realism', tip: 'Not everyone gets healed.' },
        
        // DIALOGUE (26-40)
        { id: 26, name: 'David Mamet', category: 'dialogue', works: 'Glengarry Glen Ross', technique: 'Sparse, rhythmic', tip: 'People rarely say what they mean.' },
        { id: 27, name: 'Diablo Cody', category: 'dialogue', works: 'Juno', technique: 'Distinctive voice', tip: 'Every character needs their own vocabulary.' },
        { id: 28, name: 'Nora Ephron', category: 'dialogue', works: 'When Harry Met Sally', technique: 'Natural banter', tip: 'Dialogue as music.' },
        { id: 29, name: 'Armando Iannucci', category: 'dialogue', works: 'Veep, In the Loop', technique: 'Insult comedy', tip: 'Comedy timing lives in pauses.' },
        { id: 30, name: 'Joel & Ethan Coen', category: 'dialogue', works: 'Fargo, No Country', technique: 'Regional dialect', tip: 'Dialogue reveals geography and class.' },
        { id: 31, name: 'Woody Allen', category: 'dialogue', works: 'Annie Hall', technique: 'Neurotic, intellectual', tip: 'Let characters talk into corners.' },
        { id: 32, name: 'Richard Linklater', category: 'dialogue', works: 'Before Sunrise trilogy', technique: 'Philosophical conversation', tip: 'Real conversations meander.' },
        { id: 33, name: 'Amy Sherman-Palladino', category: 'dialogue', works: 'Gilmore Girls', technique: 'Rapid-fire', tip: 'Density creates character.' },
        { id: 34, name: 'Tony Gilroy', category: 'dialogue', works: 'Michael Clayton', technique: 'Corporate subtext', tip: 'What\'s NOT said matters most.' },
        { id: 35, name: 'Taylor Sheridan', category: 'dialogue', works: 'Sicario, Yellowstone', technique: 'Laconic, Western', tip: 'Fewer words, more weight.' },
        { id: 36, name: 'Eric Roth', category: 'dialogue', works: 'Forrest Gump', technique: 'Sweeping emotion', tip: 'Find the humanity in epic.' },
        { id: 37, name: 'Tony Kushner', category: 'dialogue', works: 'Lincoln', technique: 'Theatrical speeches', tip: 'Monologues can be cinema.' },
        { id: 38, name: 'Paddy Chayefsky', category: 'dialogue', works: 'Network', technique: 'Passionate rants', tip: 'Let characters explode.' },
        { id: 39, name: 'Billy Wilder', category: 'dialogue', works: 'Some Like It Hot', technique: 'Setup/payoff', tip: 'Act 3 problems? Fix Act 1.' },
        { id: 40, name: 'Preston Sturges', category: 'dialogue', works: 'Sullivan\'s Travels', technique: 'Screwball comedy', tip: 'Fast and furious.' },
        
        // TV MASTERS (41-55)
        { id: 41, name: 'Vince Gilligan', category: 'tv', works: 'Breaking Bad', technique: 'Slow burn transformation', tip: 'Mr. Chips to Scarface.' },
        { id: 42, name: 'David Chase', category: 'tv', works: 'The Sopranos', technique: 'Antihero complexity', tip: 'Sympathy for the devil.' },
        { id: 43, name: 'David Simon', category: 'tv', works: 'The Wire', technique: 'Systemic storytelling', tip: 'Institutions as characters.' },
        { id: 44, name: 'Shonda Rhimes', category: 'tv', works: 'Grey\'s Anatomy', technique: 'Cliffhangers', tip: 'End every act with a question.' },
        { id: 45, name: 'Dan Harmon', category: 'tv', works: 'Community, Rick and Morty', technique: 'Story Circle', tip: 'The embryo of story.' },
        { id: 46, name: 'Damon Lindelof', category: 'tv', works: 'Lost, The Leftovers', technique: 'Mystery boxes', tip: 'Questions beat answers.' },
        { id: 47, name: 'Jesse Armstrong', category: 'tv', works: 'Succession', technique: 'Dark comedy', tip: 'Make them awful but watchable.' },
        { id: 48, name: 'Mike White', category: 'tv', works: 'The White Lotus', technique: 'Social satire', tip: 'Privilege exposed.' },
        { id: 49, name: 'Noah Hawley', category: 'tv', works: 'Fargo (TV)', technique: 'Tonal shifts', tip: 'Genre-bending within episodes.' },
        { id: 50, name: 'Craig Mazin', category: 'tv', works: 'Chernobyl, Last of Us', technique: 'Research + emotion', tip: 'Truth is dramatic enough.' },
        { id: 51, name: 'Lisa Joy & Jonathan Nolan', category: 'tv', works: 'Westworld', technique: 'Puzzle box', tip: 'Reward careful viewers.' },
        { id: 52, name: 'Ryan Murphy', category: 'tv', works: 'American Horror Story', technique: 'Anthology', tip: 'Reinvent each season.' },
        { id: 53, name: 'Michaela Coel', category: 'tv', works: 'I May Destroy You', technique: 'Personal trauma as art', tip: 'Authenticity above comfort.' },
        { id: 54, name: 'Sally Wainwright', category: 'tv', works: 'Happy Valley', technique: 'Strong female leads', tip: 'Women can be complex.' },
        { id: 55, name: 'Jed Mercurio', category: 'tv', works: 'Line of Duty', technique: 'Procedural tension', tip: 'Make bureaucracy thrilling.' },
        
        // COMEDY (56-65)
        { id: 56, name: 'Mel Brooks', category: 'comedy', works: 'Blazing Saddles', technique: 'Parody', tip: 'Tragedy + time = comedy.' },
        { id: 57, name: 'Judd Apatow', category: 'comedy', works: '40-Year-Old Virgin', technique: 'Improv-friendly', tip: 'Let actors find the funny.' },
        { id: 58, name: 'Tina Fey', category: 'comedy', works: '30 Rock, Mean Girls', technique: 'Joke density', tip: 'More jokes per page.' },
        { id: 59, name: 'Edgar Wright', category: 'comedy', works: 'Shaun of the Dead', technique: 'Visual comedy', tip: 'Every frame is setup or payoff.' },
        { id: 60, name: 'Lord & Miller', category: 'comedy', works: 'LEGO Movie', technique: 'Meta-comedy', tip: 'Acknowledge the absurdity.' },
        { id: 61, name: 'Mike Judge', category: 'comedy', works: 'Office Space', technique: 'Workplace absurdity', tip: 'Mundane horror is comedy.' },
        { id: 62, name: 'Seth Rogen', category: 'comedy', works: 'Superbad', technique: 'Friendship comedy', tip: 'Authentic friendship.' },
        { id: 63, name: 'Bo Burnham', category: 'comedy', works: 'Eighth Grade', technique: 'Cringe + heart', tip: 'Awkwardness is universal.' },
        { id: 64, name: 'Charlie Day', category: 'comedy', works: 'Always Sunny', technique: 'Unlikeable protagonists', tip: 'Make them awful, make them funny.' },
        { id: 65, name: 'Nick Kroll', category: 'comedy', works: 'Big Mouth', technique: 'Animated honesty', tip: 'Animation allows more truth.' },
        
        // HORROR (66-75)
        { id: 66, name: 'Ari Aster', category: 'horror', works: 'Hereditary, Midsommar', technique: 'Dread, grief-horror', tip: 'Family trauma is the real monster.' },
        { id: 67, name: 'Mike Flanagan', category: 'horror', works: 'Haunting of Hill House', technique: 'Character-driven horror', tip: 'Ghosts are metaphors.' },
        { id: 68, name: 'Robert Eggers', category: 'horror', works: 'The Witch', technique: 'Period authenticity', tip: 'Research creates atmosphere.' },
        { id: 69, name: 'James Wan', category: 'horror', works: 'Conjuring', technique: 'Set-piece horror', tip: 'Build to the scare.' },
        { id: 70, name: 'Leigh Whannell', category: 'horror', works: 'Invisible Man', technique: 'High concept', tip: 'One idea, fully explored.' },
        { id: 71, name: 'John Carpenter', category: 'horror', works: 'Halloween', technique: 'Minimalist suspense', tip: 'Less is more scary.' },
        { id: 72, name: 'Wes Craven', category: 'horror', works: 'Scream', technique: 'Meta-horror', tip: 'Know the rules to break them.' },
        { id: 73, name: 'David Cronenberg', category: 'horror', works: 'The Fly', technique: 'Body horror', tip: 'The flesh is the canvas.' },
        { id: 74, name: 'Ti West', category: 'horror', works: 'X, Pearl', technique: 'Retro horror', tip: 'Genre pastiche with depth.' },
        { id: 75, name: 'Jennifer Kent', category: 'horror', works: 'The Babadook', technique: 'Psychological horror', tip: 'The monster is grief.' },
        
        // SCI-FI (76-85)
        { id: 76, name: 'George Lucas', category: 'scifi', works: 'Star Wars', technique: 'Mythology in space', tip: 'Campbell in a galaxy far away.' },
        { id: 77, name: 'Peter Jackson', category: 'scifi', works: 'LOTR', technique: 'Adaptation, scale', tip: 'Respect source, serve the film.' },
        { id: 78, name: 'The Wachowskis', category: 'scifi', works: 'The Matrix', technique: 'Philosophical action', tip: 'Ideas can be visualized.' },
        { id: 79, name: 'Alex Garland', category: 'scifi', works: 'Ex Machina', technique: 'Cerebral sci-fi', tip: 'Sci-fi as philosophy.' },
        { id: 80, name: 'Ted Chiang', category: 'scifi', works: 'Arrival', technique: 'Linguistic sci-fi', tip: 'Language shapes reality.' },
        { id: 81, name: 'James Cameron', category: 'scifi', works: 'Terminator, Aliens', technique: 'Stakes + spectacle', tip: 'Technology serves emotion.' },
        { id: 82, name: 'Ridley Scott', category: 'scifi', works: 'Blade Runner', technique: 'World-building detail', tip: 'Every corner tells a story.' },
        { id: 83, name: 'Hayao Miyazaki', category: 'scifi', works: 'Spirited Away', technique: 'Environmental fantasy', tip: 'Nature as character.' },
        { id: 84, name: 'Terry Gilliam', category: 'scifi', works: 'Brazil', technique: 'Dystopian satire', tip: 'Bureaucracy is the enemy.' },
        { id: 85, name: 'Neill Blomkamp', category: 'scifi', works: 'District 9', technique: 'Allegory sci-fi', tip: 'Sci-fi as social mirror.' },
        
        // INTERNATIONAL (86-100)
        { id: 86, name: 'Akira Kurosawa', category: 'international', works: 'Seven Samurai, Rashomon', technique: 'Multiple perspectives', tip: 'Truth is subjective.' },
        { id: 87, name: 'Ingmar Bergman', category: 'international', works: 'Persona', technique: 'Existential dialogue', tip: 'Face the void.' },
        { id: 88, name: 'Federico Fellini', category: 'international', works: '8Â½', technique: 'Dream logic', tip: 'Reality is overrated.' },
        { id: 89, name: 'FranÃ§ois Truffaut', category: 'international', works: '400 Blows', technique: 'Autobiographical', tip: 'Write what you know, deeply.' },
        { id: 90, name: 'Andrei Tarkovsky', category: 'international', works: 'Stalker', technique: 'Poetic imagery', tip: 'Time is the medium.' },
        { id: 91, name: 'Park Chan-wook', category: 'international', works: 'Oldboy', technique: 'Revenge aesthetics', tip: 'Vengeance as opera.' },
        { id: 92, name: 'Asghar Farhadi', category: 'international', works: 'A Separation', technique: 'Moral complexity', tip: 'No villains, only perspectives.' },
        { id: 93, name: 'Alfonso CuarÃ³n', category: 'international', works: 'Roma', technique: 'Long takes', tip: 'The camera is a character.' },
        { id: 94, name: 'Alejandro G. IÃ±Ã¡rritu', category: 'international', works: 'Birdman', technique: 'Interconnected stories', tip: 'Everything is connected.' },
        { id: 95, name: 'Wong Kar-wai', category: 'international', works: 'In the Mood for Love', technique: 'Yearning', tip: 'What could have been.' },
        { id: 96, name: 'Pedro AlmodÃ³var', category: 'international', works: 'Talk to Her', technique: 'Elevated melodrama', tip: 'Embrace big emotions.' },
        { id: 97, name: 'Hirokazu Kore-eda', category: 'international', works: 'Shoplifters', technique: 'Quiet family drama', tip: 'Found family, chosen bonds.' },
        { id: 98, name: 'Lee Chang-dong', category: 'international', works: 'Burning', technique: 'Ambiguity', tip: 'Let audiences complete the story.' },
        { id: 99, name: 'Paolo Sorrentino', category: 'international', works: 'The Great Beauty', technique: 'Decadence and meaning', tip: 'Beauty masks emptiness.' },
        { id: 100, name: 'Florian von Donnersmarck', category: 'international', works: 'Lives of Others', technique: 'Surveillance drama', tip: 'The watcher becomes watched.' }
    ];

    const masterCategories = {
        all: 'Alle Meesters',
        structure: 'Structuur & Plot',
        character: 'Karakter & Arc',
        dialogue: 'Dialoog',
        tv: 'TV Series',
        comedy: 'Comedy',
        horror: 'Horror & Thriller',
        scifi: 'Sci-Fi & Fantasy',
        international: 'Internationale Meesters'
    };

    // ============================================
    // WRITER ASSISTANT FUNCTIONS
    // ============================================

    function getCurrentMethodBeats() {
        return writingMethods[state.writer.method]?.beats || [];
    }

    function getBeatContent(beatId) {
        const key = `${state.writer.method}_${beatId}`;
        return state.writer.beats[key] || '';
    }

    function setBeatContent(beatId, content) {
        const key = `${state.writer.method}_${beatId}`;
        state.writer.beats[key] = content;
        saveState();
    }

    async function generateBeatSuggestions(beat) {
        if (!state.settings.apiKey) {
            alert('Vul eerst je API key in via Settings.');
            return;
        }

        state.writer.isGenerating = true;
        state.writer.suggestions = [];
        render();

        const method = writingMethods[state.writer.method];
        const previousBeats = getCurrentMethodBeats()
            .filter(b => b.id < beat.id)
            .map(b => `${b.name}: ${getBeatContent(b.id) || '(nog leeg)'}`)
            .join('\n');

        const prompt = `Je bent een expert scenarioschrijver. Help met de ${method.name} methode.

BELANGRIJK: Antwoord VOLLEDIG in het Nederlands.
${getMasterPromptText()}
CONTEXT:
- Genre: ${state.writer.genre}
- Logline: ${state.writer.logline || '(nog niet ingevuld)'}
- Vorige beats: ${previousBeats || '(eerste beat)'}

HUIDIGE BEAT: ${beat.name} (pagina ${beat.page})
Beschrijving: ${beat.description}

Geef 3 suggesties in het Nederlands in JSON:
{
  "suggestions": [
    {"type": "conventional", "title": "Nederlandse titel", "description": "2-3 zinnen in het Nederlands", "reasoning": "Waarom het werkt"},
    {"type": "surprising", "title": "Nederlandse titel", "description": "2-3 zinnen in het Nederlands", "reasoning": "Waarom het werkt"},
    {"type": "bold", "title": "Nederlandse titel", "description": "2-3 zinnen in het Nederlands", "reasoning": "Waarom het werkt"}
  ]
}`;

        try {
            const response = await callClaudeAPI(prompt);
            const jsonMatch = response.match(/\{[\s\S]*\}/);
            if (jsonMatch) {
                const data = JSON.parse(jsonMatch[0]);
                state.writer.suggestions = data.suggestions || [];
            }
        } catch (error) {
            console.error('Error generating suggestions:', error);
            alert('Fout bij genereren: ' + error.message);
        }

        state.writer.isGenerating = false;
        render();
    }

    function selectSuggestion(suggestion) {
        const beats = getCurrentMethodBeats();
        const currentBeat = beats[state.writer.currentBeat];
        if (currentBeat) {
            setBeatContent(currentBeat.id, `${suggestion.title}\n\n${suggestion.description}`);
            state.writer.suggestions = [];
            render();
        }
    }

    function getRandomMasterTip() {
        return masterWriters[Math.floor(Math.random() * masterWriters.length)];
    }

    function getFilteredMasters() {
        if (state.writer.masterFilter === 'all') return masterWriters;
        return masterWriters.filter(m => m.category === state.writer.masterFilter);
    }

    // Helper functie voor meester dropdown HTML
    function renderMasterDropdown() {
        const selected = state.writer.selectedMaster ? 
            masterWriters.find(m => m.id === state.writer.selectedMaster) : null;
        
        return `
            <div class="form-group">
                <label class="form-label">ðŸŽ“ Schrijf in de stijl van</label>
                <select class="form-input" onchange="state.writer.selectedMaster = this.value ? parseInt(this.value) : null; render()">
                    <option value="">-- Geen meester (standaard) --</option>
                    <optgroup label="Structuur & Plot">
                        ${masterWriters.filter(m => m.category === 'structure').map(m => 
                            `<option value="${m.id}" ${state.writer.selectedMaster === m.id ? 'selected' : ''}>${m.name}</option>`
                        ).join('')}
                    </optgroup>
                    <optgroup label="Karakter & Arc">
                        ${masterWriters.filter(m => m.category === 'character').map(m => 
                            `<option value="${m.id}" ${state.writer.selectedMaster === m.id ? 'selected' : ''}>${m.name}</option>`
                        ).join('')}
                    </optgroup>
                    <optgroup label="Dialoog">
                        ${masterWriters.filter(m => m.category === 'dialogue').map(m => 
                            `<option value="${m.id}" ${state.writer.selectedMaster === m.id ? 'selected' : ''}>${m.name}</option>`
                        ).join('')}
                    </optgroup>
                    <optgroup label="TV Series">
                        ${masterWriters.filter(m => m.category === 'tv').map(m => 
                            `<option value="${m.id}" ${state.writer.selectedMaster === m.id ? 'selected' : ''}>${m.name}</option>`
                        ).join('')}
                    </optgroup>
                    <optgroup label="Comedy">
                        ${masterWriters.filter(m => m.category === 'comedy').map(m => 
                            `<option value="${m.id}" ${state.writer.selectedMaster === m.id ? 'selected' : ''}>${m.name}</option>`
                        ).join('')}
                    </optgroup>
                    <optgroup label="Horror & Thriller">
                        ${masterWriters.filter(m => m.category === 'horror').map(m => 
                            `<option value="${m.id}" ${state.writer.selectedMaster === m.id ? 'selected' : ''}>${m.name}</option>`
                        ).join('')}
                    </optgroup>
                    <optgroup label="Sci-Fi & Fantasy">
                        ${masterWriters.filter(m => m.category === 'scifi').map(m => 
                            `<option value="${m.id}" ${state.writer.selectedMaster === m.id ? 'selected' : ''}>${m.name}</option>`
                        ).join('')}
                    </optgroup>
                    <optgroup label="Internationale Meesters">
                        ${masterWriters.filter(m => m.category === 'international').map(m => 
                            `<option value="${m.id}" ${state.writer.selectedMaster === m.id ? 'selected' : ''}>${m.name}</option>`
                        ).join('')}
                    </optgroup>
                </select>
                ${selected ? `
                    <div style="margin-top: 0.5rem; padding: 0.75rem; background: rgba(245, 158, 11, 0.1); border-radius: 6px; font-size: 0.85rem;">
                        <strong>ðŸŽ¯ ${selected.technique}</strong><br>
                        <em>"${selected.tip}"</em><br>
                        <span style="color: var(--text-muted);">Bekend van: ${selected.works}</span>
                    </div>
                ` : ''}
            </div>
        `;
    }

    // Helper functie voor meester prompt tekst
    function getMasterPromptText() {
        if (!state.writer.selectedMaster) return '';
        
        const master = masterWriters.find(m => m.id === state.writer.selectedMaster);
        if (!master) return '';
        
        return `

SCHRIJFSTIJL - SCHRIJF ALS ${master.name.toUpperCase()}:
Je schrijft nu in de stijl van ${master.name}, bekend van: ${master.works}.
Kerntechniek: ${master.technique}
Filosofie: "${master.tip}"

Pas deze stijl en technieken toe in je output. Denk en schrijf zoals ${master.name} zou doen.
`;
    }

    // ============================================
    // SCENE BUILDER FUNCTIONS
    // ============================================

    async function generateScene() {
        if (!state.settings.apiKey) {
            alert('Vul eerst je API key in via Settings.');
            return;
        }

        const s = state.writer.scene;
        if (!s.location || !s.objective) {
            alert('Vul minimaal locatie en doel in.');
            return;
        }

        state.writer.isGenerating = true;
        render();

        const prompt = `Je bent een ervaren scenarioschrijver. Genereer een complete scene in professioneel screenplay format.

BELANGRIJK: Schrijf de VOLLEDIGE scene in het NEDERLANDS. Alle dialoog en action lines moeten in het Nederlands zijn.
${getMasterPromptText()}
SCENE DETAILS:
- Locatie: ${s.intExt}. ${s.location} - ${s.timeOfDay}
- Karakters: ${s.characters.join(', ') || 'Nog te bepalen'}
- Doel van de scene: ${s.objective}
- Conflict: ${s.conflict || 'Subtiel conflict'}
- Toon: ${s.tone}
- Genre: ${state.writer.genre}
- Logline van het script: ${state.writer.logline || '(niet ingevuld)'}

INSTRUCTIES:
1. Begin met de scene heading (INT./EXT. LOCATIE - TIJD)
2. Schrijf action lines in tegenwoordige tijd IN HET NEDERLANDS
3. Karakter namen in HOOFDLETTERS bij eerste introductie
4. Dialoog met karakter naam gecentreerd, tekst eronder - IN HET NEDERLANDS
5. Gebruik parentheticals spaarzaam
6. Scene moet 1-2 pagina's zijn (ongeveer 1 pagina = 1 minuut screen time)
7. Eindig met een duidelijk einde of cliffhanger

Schrijf de volledige scene in professioneel screenplay format, VOLLEDIG IN HET NEDERLANDS:`;

        try {
            const response = await callClaudeAPI(prompt);
            state.writer.scene.generatedScene = response;
        } catch (error) {
            console.error('Error generating scene:', error);
            alert('Fout bij genereren: ' + error.message);
        }

        state.writer.isGenerating = false;
        render();
    }

    // ============================================
    // DIALOGUE GENERATOR FUNCTIONS
    // ============================================

    async function generateDialogueOptions() {
        if (!state.settings.apiKey) {
            alert('Vul eerst je API key in via Settings.');
            return;
        }

        const d = state.writer.dialogue;
        if (!d.speaker || !d.objective) {
            alert('Vul minimaal spreker en doel in.');
            return;
        }

        state.writer.isGenerating = true;
        state.writer.dialogue.options = [];
        render();

        const prompt = `Je bent een dialoog-expert. Genereer 3 verschillende versies van hetzelfde dialoogfragment.

BELANGRIJK: Schrijf ALLE dialoog in het NEDERLANDS.
${getMasterPromptText()}
CONTEXT:
- Wie spreekt: ${d.speaker}
- Tegen wie: ${d.listener || 'onbekend'}
- Wat wil ${d.speaker} bereiken: ${d.objective}
- Subtext/wat wordt NIET gezegd: ${d.subtext || 'geen specifieke subtext'}
- Toon: ${d.tone}
- Genre: ${state.writer.genre}

Geef 3 versies in JSON format, met NEDERLANDSE dialoog:
{
  "options": [
    {
      "style": "Subtiel",
      "description": "Korte beschrijving van de aanpak in het Nederlands",
      "dialogue": "De daadwerkelijke NEDERLANDSE dialoog (2-4 regels)"
    },
    {
      "style": "Direct",
      "description": "Korte beschrijving van de aanpak in het Nederlands",
      "dialogue": "De daadwerkelijke NEDERLANDSE dialoog (2-4 regels)"
    },
    {
      "style": "Gedurfd",
      "description": "Korte beschrijving van de aanpak in het Nederlands",
      "dialogue": "De daadwerkelijke NEDERLANDSE dialoog (2-4 regels)"
    }
  ]
}`;

        try {
            const response = await callClaudeAPI(prompt);
            const jsonMatch = response.match(/\{[\s\S]*\}/);
            if (jsonMatch) {
                const data = JSON.parse(jsonMatch[0]);
                state.writer.dialogue.options = data.options || [];
            }
        } catch (error) {
            console.error('Error generating dialogue:', error);
            alert('Fout bij genereren: ' + error.message);
        }

        state.writer.isGenerating = false;
        render();
    }

    // ============================================
    // CONFLICT ESCALATOR FUNCTIONS
    // ============================================

    async function generateConflictEscalations() {
        if (!state.settings.apiKey) {
            alert('Vul eerst je API key in via Settings.');
            return;
        }

        const baseConflict = state.writer.conflict.baseConflict;
        if (!baseConflict) {
            alert('Beschrijf eerst het basisconflict.');
            return;
        }

        state.writer.isGenerating = true;
        state.writer.conflict.escalations = [];
        render();

        const prompt = `Je bent een expert in dramatische spanning. Neem dit basisconflict en escaleer het in 5 niveaus van mild naar explosief.

BELANGRIJK: Antwoord VOLLEDIG in het NEDERLANDS.
${getMasterPromptText()}
BASISCONFLICT:
${baseConflict}

GENRE: ${state.writer.genre}
LOGLINE: ${state.writer.logline || '(niet ingevuld)'}

Geef 5 escalatieniveaus in JSON, ALLES IN HET NEDERLANDS:
{
  "escalations": [
    {
      "level": 1,
      "name": "Onderhuidse Spanning",
      "description": "Hoe het conflict subtiel begint (Nederlands)",
      "example": "Concrete scÃ¨ne-beschrijving in het Nederlands"
    },
    {
      "level": 2,
      "name": "Eerste Confrontatie",
      "description": "De eerste openlijke botsing (Nederlands)",
      "example": "Concrete scÃ¨ne-beschrijving in het Nederlands"
    },
    {
      "level": 3,
      "name": "Escalatie",
      "description": "Stakes worden verhoogd (Nederlands)",
      "example": "Concrete scÃ¨ne-beschrijving in het Nederlands"
    },
    {
      "level": 4,
      "name": "Point of No Return",
      "description": "Geen weg terug (Nederlands)",
      "example": "Concrete scÃ¨ne-beschrijving in het Nederlands"
    },
    {
      "level": 5,
      "name": "Explosie",
      "description": "Maximale confrontatie (Nederlands)",
      "example": "Concrete scÃ¨ne-beschrijving in het Nederlands"
    }
  ]
}`;

        try {
            const response = await callClaudeAPI(prompt);
            const jsonMatch = response.match(/\{[\s\S]*\}/);
            if (jsonMatch) {
                const data = JSON.parse(jsonMatch[0]);
                state.writer.conflict.escalations = data.escalations || [];
            }
        } catch (error) {
            console.error('Error generating escalations:', error);
            alert('Fout bij genereren: ' + error.message);
        }

        state.writer.isGenerating = false;
        render();
    }

    // ============================================
    // PLOT TWIST GENERATOR FUNCTIONS
    // ============================================

    const twistCategories = {
        all: 'Alle Twists',
        character: 'Karakter Onthulling',
        perspective: 'Perspectief Shift',
        time: 'Tijd Twist',
        relationship: 'Relatie Twist',
        reality: 'Realiteit Twist'
    };

    async function generatePlotTwists() {
        if (!state.settings.apiKey) {
            alert('Vul eerst je API key in via Settings.');
            return;
        }

        state.writer.isGenerating = true;
        state.writer.twist.twists = [];
        render();

        const category = state.writer.twist.category;
        const categoryText = category === 'all' ? 'verschillende categorieÃ«n' : twistCategories[category];

        const prompt = `Je bent een meester in plot twists. Genereer 5 originele plot twists.

BELANGRIJK: Antwoord VOLLEDIG in het NEDERLANDS.
${getMasterPromptText()}
CONTEXT:
- Genre: ${state.writer.genre}
- Logline: ${state.writer.logline || '(nog niet ingevuld)'}
- Extra context: ${state.writer.twist.context || '(geen)'}
- Categorie: ${categoryText}

TWIST CATEGORIEÃ‹N:
- character: Karakter onthulling (hij was de moordenaar, zij is zijn zus)
- perspective: Perspectief shift (unreliable narrator, we zagen het verkeerd)
- time: Tijd twist (we zijn in de toekomst, flashback onthulling)
- relationship: Relatie twist (ze zijn familie, geheime romance)
- reality: Realiteit twist (het was een droom, simulatie, hallucinatie)

Geef 5 twists in JSON, ALLES IN HET NEDERLANDS:
{
  "twists": [
    {
      "category": "character/perspective/time/relationship/reality",
      "title": "Korte Nederlandse titel",
      "setup": "Wat moet er eerst opgezet worden (Nederlands)",
      "reveal": "De twist zelf (Nederlands)",
      "impact": "Waarom dit werkt (Nederlands)",
      "example": "Bekende film/serie die dit deed"
    }
  ]
}`;

        try {
            const response = await callClaudeAPI(prompt);
            const jsonMatch = response.match(/\{[\s\S]*\}/);
            if (jsonMatch) {
                const data = JSON.parse(jsonMatch[0]);
                let twists = data.twists || [];
                if (category !== 'all') {
                    twists = twists.filter(t => t.category === category);
                }
                state.writer.twist.twists = twists;
            }
        } catch (error) {
            console.error('Error generating twists:', error);
            alert('Fout bij genereren: ' + error.message);
        }

        state.writer.isGenerating = false;
        render();
    }

    // ============================================
    // EXPORT FUNCTIONS
    // ============================================

    function exportBeatsToText() {
        const method = writingMethods[state.writer.method];
        const beats = getCurrentMethodBeats();
        
        let text = `${method.name} - ${method.author}\n`;
        text += `Genre: ${state.writer.genre}\n`;
        text += `Logline: ${state.writer.logline || '(niet ingevuld)'}\n`;
        text += `${'='.repeat(50)}\n\n`;

        beats.forEach(beat => {
            const content = getBeatContent(beat.id);
            text += `BEAT ${beat.id}: ${beat.name} (p.${beat.page})\n`;
            text += `${'-'.repeat(40)}\n`;
            text += `${content || '(nog niet ingevuld)'}\n\n`;
        });

        downloadFile(text, `beats-${state.writer.method}-${Date.now()}.txt`, 'text/plain');
    }

    function exportBeatsToJSON() {
        const method = writingMethods[state.writer.method];
        const beats = getCurrentMethodBeats();
        
        const data = {
            method: method.name,
            author: method.author,
            genre: state.writer.genre,
            logline: state.writer.logline,
            exportedAt: new Date().toISOString(),
            beats: beats.map(beat => ({
                id: beat.id,
                name: beat.name,
                page: beat.page,
                description: beat.description,
                content: getBeatContent(beat.id) || ''
            }))
        };

        downloadFile(JSON.stringify(data, null, 2), `beats-${state.writer.method}-${Date.now()}.json`, 'application/json');
    }

    function exportSceneToFountain() {
        const scene = state.writer.scene.generatedScene;
        if (!scene) {
            alert('Genereer eerst een scene.');
            return;
        }
        downloadFile(scene, `scene-${Date.now()}.fountain`, 'text/plain');
    }

    function downloadFile(content, filename, mimeType) {
        const blob = new Blob([content], { type: mimeType });
        const url = URL.createObjectURL(blob);
        const a = document.createElement('a');
        a.href = url;
        a.download = filename;
        document.body.appendChild(a);
        a.click();
        document.body.removeChild(a);
        URL.revokeObjectURL(url);
    }

    function copyToClipboard(text, buttonElement) {
        navigator.clipboard.writeText(text).then(() => {
            if (buttonElement) {
                const originalText = buttonElement.innerText;
                buttonElement.innerText = 'âœ“ Gekopieerd!';
                buttonElement.classList.add('copied');
                setTimeout(() => {
                    buttonElement.innerText = originalText;
                    buttonElement.classList.remove('copied');
                }, 2000);
            }
        });
    }

    // ============================================
    // MASTER DETAIL MODAL
    // ============================================

    function showMasterDetailModal(masterId) {
        state.ui.showMasterDetail = masterId;
        render();
    }

    function closeMasterDetailModal() {
        state.ui.showMasterDetail = null;
        render();
    }

    function applyMasterStyle(master) {
        // Store the selected master for the AI to reference
        const prompt = `Pas de stijl van ${master.name} toe op mijn volgende schrijfwerk. 
Techniek: ${master.technique}
Tip: "${master.tip}"
Bekend van: ${master.works}`;
        
        // Add to chat context
        state.chat.messages.push({
            role: 'user',
            content: `Ik wil schrijven in de stijl van ${master.name}. Help me met de volgende scene/beat met hun techniek: ${master.technique}`
        });
        
        closeMasterDetailModal();
        state.activeTab = 'chat';
        render();
        
        // Trigger AI response
        sendChatMessage(`Ik heb zojuist ${master.name} geselecteerd als stijlvoorbeeld. Hun kerntechniek is "${master.technique}" en hun tip is "${master.tip}". Hoe kan ik dit toepassen op mijn ${state.writer.genre} verhaal?`);
    }

    function escapeHtml(text) {
        const div = document.createElement('div');
        div.textContent = text;
        return div.innerHTML;
    }

    function renderHeader() {
        return `
            <header class="header glass">
                <div class="logo">
                    <div class="logo-icon">ðŸŽ¬</div>
                    <h1>ScriptMaster Pro</h1>
                </div>
                <div class="header-actions">
                    <button class="btn btn-ghost" onclick="state.ui.showSettings = true; render()">
                        <i data-lucide="settings"></i>
                    </button>
                </div>
            </header>
        `;
    }

    function renderNav() {
        const tabs = [
            { id: 'scripts', icon: 'file-text', label: 'Scripts' },
            { id: 'writer', icon: 'pen-tool', label: 'Schrijf Assistent' },
            { id: 'characters', icon: 'users', label: 'Karakters' },
            { id: 'locations', icon: 'map-pin', label: 'Locaties' },
            { id: 'storyframe', icon: 'layout', label: 'Storyframe' },
            { id: 'continuity', icon: 'check-circle', label: 'ContinuÃ¯teit' },
            { id: 'chat', icon: 'message-square', label: 'AI Chat' }
        ];

        return `
            <nav class="nav-tabs">
                ${tabs.map(tab => `
                    <button class="nav-tab ${state.activeTab === tab.id ? 'active' : ''}" 
                            onclick="state.activeTab = '${tab.id}'; render()">
                        <i data-lucide="${tab.icon}"></i>
                        <span>${tab.label}</span>
                    </button>
                `).join('')}
            </nav>
        `;
    }

    function renderScriptsTab() {
        return `
            <div>
                <div class="card" style="margin-bottom: 1.5rem;">
                    <div class="card-body">
                        <div class="upload-zone" id="uploadZone" onclick="document.getElementById('fileInput').click()">
                            <i data-lucide="upload-cloud"></i>
                            <h3>Upload Scripts</h3>
                            <p>Sleep bestanden hierheen of klik om te uploaden</p>
                            <p style="margin-top: 0.5rem; font-size: 0.8rem;">.txt, .fountain, .pdf, .docx</p>
                        </div>
                        <input type="file" id="fileInput" class="hidden-input" multiple 
                               accept=".txt,.fountain,.pdf,.docx"
                               onchange="handleFileUpload(event)">
                    </div>
                </div>

                ${state.scripts.length === 0 ? `
                    <div class="empty-state">
                        <i data-lucide="file-text"></i>
                        <h3>Nog geen scripts</h3>
                        <p>Upload je eerste script om te beginnen</p>
                    </div>
                ` : `
                    <div class="grid-2">
                        ${state.scripts.map((script, index) => `
                            <div class="script-item" onclick="viewScript(${index})">
                                <div class="script-icon">
                                    <i data-lucide="file-text"></i>
                                </div>
                                <div class="script-info">
                                    <div class="script-title">${escapeHtml(script.title)}</div>
                                    <div class="script-meta">
                                        <span class="stat-badge">${script.stats.sceneCount} scenes</span>
                                        <span class="stat-badge">${script.stats.characterCount} karakters</span>
                                    </div>
                                </div>
                                <div class="script-actions">
                                    <button class="btn btn-ghost" onclick="event.stopPropagation(); deleteScript(${index})">
                                        <i data-lucide="trash-2"></i>
                                    </button>
                                </div>
                            </div>
                        `).join('')}
                    </div>
                `}
            </div>
        `;
    }

    function renderCharactersTab() {
        if (state.characters.length === 0) {
            return `
                <div class="empty-state">
                    <i data-lucide="users"></i>
                    <h3>Nog geen karakters</h3>
                    <p>Upload scripts om karakters te zien</p>
                </div>
            `;
        }

        return `
            <div class="grid-3">
                ${state.characters.map(char => `
                    <div class="entity-card">
                        <div class="entity-name">
                            <i data-lucide="user" style="width: 16px; height: 16px;"></i>
                            ${escapeHtml(char.name)}
                        </div>
                        <div class="entity-stats">
                            <span>${char.scenes.length} scenes</span>
                            <span>${char.dialogueCount} dialogen</span>
                        </div>
                        <div style="margin-top: 0.5rem; font-size: 0.8rem; color: var(--text-muted);">
                            ${char.scripts.slice(0, 2).join(', ')}${char.scripts.length > 2 ? '...' : ''}
                        </div>
                    </div>
                `).join('')}
            </div>
        `;
    }

    function renderLocationsTab() {
        if (state.locations.length === 0) {
            return `
                <div class="empty-state">
                    <i data-lucide="map-pin"></i>
                    <h3>Nog geen locaties</h3>
                    <p>Upload scripts om locaties te zien</p>
                </div>
            `;
        }

        return `
            <div class="grid-3">
                ${state.locations.map(loc => `
                    <div class="entity-card">
                        <div class="entity-name">
                            <i data-lucide="map-pin" style="width: 16px; height: 16px;"></i>
                            ${escapeHtml(loc.name)}
                        </div>
                        <div class="entity-stats">
                            <span>${loc.scenes.length} scenes</span>
                            <span>${loc.scripts.length} scripts</span>
                        </div>
                    </div>
                `).join('')}
            </div>
        `;
    }

    function renderStoryframeTab() {
        const currentGenre = genres[state.storyframe.genre];
        
        return `
            <div class="storyframe-container">
                <!-- Info Card -->
                <div class="card" style="background: linear-gradient(135deg, rgba(245, 158, 11, 0.1), rgba(139, 92, 246, 0.1)); border: 1px solid var(--accent);">
                    <div class="card-body" style="padding: 1rem;">
                        <div style="display: flex; align-items: center; gap: 0.75rem; margin-bottom: 0.5rem;">
                            <i data-lucide="info" style="color: var(--accent);"></i>
                            <strong style="color: var(--accent);">Wat is de Storyframe Tool?</strong>
                        </div>
                        <p style="font-size: 0.9rem; color: var(--text-secondary); margin: 0;">
                            Deze tool helpt schrijvers om een <strong>lange lijn</strong> (het verhaal voor meerdere weken) 
                            om te zetten naar concrete <strong>beats per week</strong>, vÃ³Ã³rdat de synopsis geschreven wordt. 
                            De tool past de 5-acten structuur toe en houdt rekening met de principes van het gekozen genre.
                        </p>
                    </div>
                </div>

                <div class="card">
                    <div class="card-header">
                        <h3><i data-lucide="file-text"></i> Lange Lijn Document</h3>
                    </div>
                    <div class="card-body">
                        <textarea class="storyframe-input" 
                                  placeholder="Plak hier je lange lijn document. Beschrijf het verhaal dat je hebt bedacht voor de komende weken/maanden. Wat is het centrale conflict? Wie zijn de hoofdpersonen? Waar gaat het verhaal naartoe? Wat zijn de belangrijkste wendingen?"
                                  oninput="state.storyframe.longLine = this.value; saveState()"
                                  style="min-height: 200px;"
                        >${state.storyframe.longLine || ''}</textarea>
                        
                        <!-- Aantal Weken Selector -->
                        <div style="margin-top: 1.5rem; display: grid; grid-template-columns: 1fr 2fr; gap: 1.5rem; align-items: start;">
                            <div>
                                <label class="form-label">Aantal Weken</label>
                                <div style="display: flex; align-items: center; gap: 0.5rem;">
                                    <input type="range" min="3" max="26" value="${state.storyframe.totalWeeks}" 
                                           oninput="state.storyframe.totalWeeks = parseInt(this.value); saveState(); render()"
                                           style="flex: 1;">
                                    <span style="min-width: 3rem; text-align: center; font-weight: bold; font-size: 1.25rem; color: var(--accent);">
                                        ${state.storyframe.totalWeeks}
                                    </span>
                                </div>
                                <div style="font-size: 0.8rem; color: var(--text-muted); margin-top: 0.25rem;">
                                    Week verdeling: ${actStructure.map((act, i) => {
                                        const range = getWeekRangeForAct(i + 1, state.storyframe.totalWeeks);
                                        return `Act ${act.act}: ${range.start}-${range.end}`;
                                    }).join(' | ')}
                                </div>
                            </div>
                            
                            <div>
                                <label class="form-label">Genre</label>
                                <div class="genre-selector">
                                    ${Object.entries(genres).map(([key, genre]) => `
                                        <button class="genre-btn ${state.storyframe.genre === key ? 'active' : ''}"
                                                onclick="state.storyframe.genre = '${key}'; saveState(); render()"
                                                style="${state.storyframe.genre === key ? 'background:' + genre.color + '; border-color:' + genre.color : ''}">
                                            ${genre.name}
                                        </button>
                                    `).join('')}
                                </div>
                            </div>
                        </div>
                        
                        <!-- Genre Info Panel -->
                        <div style="margin-top: 1.5rem; padding: 1rem; background: rgba(${currentGenre.color === '#3b82f6' ? '59,130,246' : currentGenre.color === '#ec4899' ? '236,72,153' : currentGenre.color === '#f43f5e' ? '244,63,94' : currentGenre.color === '#ef4444' ? '239,68,68' : currentGenre.color === '#22c55e' ? '34,197,94' : '139,92,246'}, 0.15); border-radius: 0.5rem; border-left: 4px solid ${currentGenre.color};">
                            <div style="font-weight: 600; color: ${currentGenre.color}; margin-bottom: 0.5rem;">
                                ${currentGenre.name} - Genre Principes
                            </div>
                            <p style="font-size: 0.9rem; color: var(--text-secondary); margin-bottom: 0.75rem;">
                                ${currentGenre.principles}
                            </p>
                            <div style="font-size: 0.85rem; color: var(--text-muted);">
                                <strong>Referenties:</strong> ${currentGenre.references.join(', ')}
                            </div>
                            <div style="font-size: 0.85rem; color: var(--text-muted); margin-top: 0.5rem; font-style: italic;">
                                ðŸ’¡ ${currentGenre.tips}
                            </div>
                        </div>
                        
                        <!-- 5 Acten Structuur Uitleg -->
                        <div style="margin-top: 1.5rem;">
                            <label class="form-label">5-Acten Structuur</label>
                            <div style="display: grid; grid-template-columns: repeat(5, 1fr); gap: 0.5rem;">
                                ${actStructure.map(act => `
                                    <div style="padding: 0.75rem; background: var(--bg-tertiary); border-radius: 0.5rem; text-align: center;">
                                        <div style="font-weight: 600; color: var(--accent); font-size: 0.8rem;">Act ${act.act}</div>
                                        <div style="font-weight: 500; font-size: 0.85rem;">${act.name}</div>
                                        <div style="font-size: 0.7rem; color: var(--text-muted); margin-top: 0.25rem;">${act.percentage}%</div>
                                    </div>
                                `).join('')}
                            </div>
                        </div>
                        
                        <div style="margin-top: 1rem;">
                            ${renderMasterDropdown()}
                        </div>
                        
                        <button class="btn btn-primary" style="margin-top: 1.5rem; width: 100%; padding: 1rem;" 
                                onclick="generateStoryframe()"
                                ${state.ui.isProcessing ? 'disabled' : ''}>
                            ${state.ui.isProcessing ? '<span class="spinner"></span> Storyframe wordt gegenereerd...' : '<i data-lucide="sparkles"></i> Genereer Storyframe'}
                        </button>
                    </div>
                </div>

                ${state.storyframe.weeks.length > 0 ? `
                    <!-- Overall Notes -->
                    ${state.storyframe.notes ? `
                        <div class="card" style="margin-top: 1.5rem; background: linear-gradient(135deg, rgba(34, 197, 94, 0.1), rgba(59, 130, 246, 0.1));">
                            <div class="card-body">
                                <div style="display: flex; align-items: center; gap: 0.5rem; margin-bottom: 0.5rem;">
                                    <i data-lucide="lightbulb" style="color: var(--success);"></i>
                                    <strong>Dramaturgische Tips voor dit Verhaal</strong>
                                </div>
                                <p style="color: var(--text-secondary); margin: 0;">${escapeHtml(state.storyframe.notes)}</p>
                            </div>
                        </div>
                    ` : ''}
                    
                    <div style="margin-top: 1.5rem;">
                        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 1rem;">
                            <h3>${state.storyframe.totalWeeks}-Weken Breakdown</h3>
                            <button class="btn btn-secondary" onclick="exportStoryframe()">
                                <i data-lucide="download"></i> Exporteer
                            </button>
                        </div>
                        <div class="grid-2">
                            ${state.storyframe.weeks.map(week => {
                                const act = week.act ? actStructure[week.act - 1] : getActForWeek(week.number, state.storyframe.totalWeeks);
                                return `
                                    <div class="week-card" style="border-left: 4px solid ${genres[state.storyframe.genre].color};">
                                        <div class="week-header">
                                            <span>Week ${week.number}</span>
                                            <span class="act-badge act-${act.act}">Act ${act.act}: ${act.name}</span>
                                        </div>
                                        <div class="week-content">
                                            <p style="margin-bottom: 0.75rem;">${escapeHtml(week.summary)}</p>
                                            <div style="font-size: 0.85rem; color: var(--text-secondary);">
                                                <strong>Key Beats:</strong>
                                                <ul style="margin-top: 0.25rem; padding-left: 1.25rem;">
                                                    ${week.beats.map(beat => `<li>${escapeHtml(beat)}</li>`).join('')}
                                                </ul>
                                            </div>
                                            <div style="margin-top: 0.75rem; font-size: 0.85rem;">
                                                <strong>Emotie:</strong> ${escapeHtml(week.emotion)}
                                            </div>
                                            ${week.genreElement ? `
                                                <div style="margin-top: 0.75rem; font-size: 0.85rem; padding: 0.5rem; background: rgba(245, 158, 11, 0.1); border-radius: 0.25rem;">
                                                    <strong style="color: var(--accent);">Genre Element:</strong> ${escapeHtml(week.genreElement)}
                                                </div>
                                            ` : ''}
                                        </div>
                                    </div>
                                `;
                            }).join('')}
                        </div>
                    </div>
                ` : ''}
            </div>
        `;
    }
    
    function exportStoryframe() {
        if (state.storyframe.weeks.length === 0) return;
        
        const genre = genres[state.storyframe.genre];
        let text = `STORYFRAME - ${genre.name.toUpperCase()}\n`;
        text += `Gegenereerd: ${new Date().toLocaleDateString('nl-NL')}\n`;
        text += `Aantal weken: ${state.storyframe.totalWeeks}\n`;
        text += `${'='.repeat(60)}\n\n`;
        
        text += `LANGE LIJN:\n${state.storyframe.longLine}\n\n`;
        text += `${'='.repeat(60)}\n\n`;
        
        if (state.storyframe.notes) {
            text += `DRAMATURGISCHE TIPS:\n${state.storyframe.notes}\n\n`;
            text += `${'='.repeat(60)}\n\n`;
        }
        
        state.storyframe.weeks.forEach(week => {
            const act = week.act ? actStructure[week.act - 1] : getActForWeek(week.number, state.storyframe.totalWeeks);
            text += `WEEK ${week.number} - Act ${act.act}: ${act.name}\n`;
            text += `${'-'.repeat(40)}\n`;
            text += `Samenvatting: ${week.summary}\n\n`;
            text += `Key Beats:\n`;
            week.beats.forEach((beat, i) => {
                text += `  ${i + 1}. ${beat}\n`;
            });
            text += `\nEmotie: ${week.emotion}\n`;
            if (week.genreElement) {
                text += `Genre Element: ${week.genreElement}\n`;
            }
            text += `\n`;
        });
        
        const blob = new Blob([text], { type: 'text/plain' });
        const url = URL.createObjectURL(blob);
        const a = document.createElement('a');
        a.href = url;
        a.download = `storyframe_${state.storyframe.totalWeeks}weken_${new Date().toISOString().split('T')[0]}.txt`;
        a.click();
        URL.revokeObjectURL(url);
    }

    function renderContinuityTab() {
        const issues = checkContinuity();
        
        return `
            <div>
                <div class="card">
                    <div class="card-header">
                        <h3>ContinuÃ¯teitscontrole</h3>
                        <button class="btn btn-secondary" onclick="render()">
                            <i data-lucide="refresh-cw"></i>
                            Opnieuw scannen
                        </button>
                    </div>
                    <div class="card-body">
                        ${state.scripts.length === 0 ? `
                            <div class="empty-state">
                                <p>Upload eerst scripts om continuÃ¯teit te controleren</p>
                            </div>
                        ` : `
                            ${issues.map(issue => `
                                <div class="continuity-issue ${issue.type}">
                                    <div style="display: flex; align-items: center; gap: 0.5rem; margin-bottom: 0.5rem;">
                                        <i data-lucide="${issue.type === 'ok' ? 'check-circle' : issue.type === 'warning' ? 'alert-triangle' : 'x-circle'}" 
                                           style="width: 18px; height: 18px; color: var(--${issue.type === 'ok' ? 'success' : issue.type === 'warning' ? 'accent' : 'error'});"></i>
                                        <strong>${issue.category}</strong>
                                    </div>
                                    <p>${escapeHtml(issue.message)}</p>
                                    <p style="font-size: 0.85rem; color: var(--text-secondary); margin-top: 0.5rem;">
                                        ðŸ’¡ ${escapeHtml(issue.suggestion)}
                                    </p>
                                </div>
                            `).join('')}
                        `}
                    </div>
                </div>
            </div>
        `;
    }

    function renderChatTab() {
        return `
            <div class="chat-container card">
                <div class="chat-messages" id="chatMessages">
                    ${state.chat.messages.length === 0 ? `
                        <div class="empty-state">
                            <i data-lucide="message-square"></i>
                            <h3>Chat met je AI Schrijfassistent</h3>
                            <p>Stel vragen over je scripts, vraag om feedback, of brainstorm nieuwe ideeÃ«n</p>
                        </div>
                    ` : `
                        ${state.chat.messages.map(msg => `
                            <div class="chat-message ${msg.role}">
                                ${escapeHtml(msg.content).replace(/\n/g, '<br>')}
                            </div>
                        `).join('')}
                        ${state.chat.isLoading ? `
                            <div class="chat-message assistant">
                                <span class="spinner"></span> Aan het denken...
                            </div>
                        ` : ''}
                    `}
                </div>
                <div class="chat-input-container">
                    <input type="text" class="chat-input" id="chatInput" 
                           placeholder="Stel een vraag over je scripts..."
                           onkeypress="if(event.key === 'Enter') sendMessage()">
                    <button class="btn btn-primary" onclick="sendMessage()">
                        <i data-lucide="send"></i>
                    </button>
                </div>
            </div>
        `;
    }

    function renderWisdomTab() {
        return `
            <div>
                ${Object.entries(masterWisdom).map(([category, wisdoms]) => `
                    <div class="wisdom-category">
                        <h3>${category.charAt(0).toUpperCase() + category.slice(1)}</h3>
                        <div class="grid-2">
                            ${wisdoms.map(w => `
                                <div class="wisdom-card">
                                    <p class="wisdom-quote">"${escapeHtml(w.wisdom)}"</p>
                                    <p class="wisdom-author">â€” ${escapeHtml(w.writer)}</p>
                                </div>
                            `).join('')}
                        </div>
                    </div>
                `).join('')}
            </div>
        `;
    }

    function renderSettingsModal() {
        if (!state.ui.showSettings) return '';

        return `
            <div class="modal-overlay" onclick="state.ui.showSettings = false; render()">
                <div class="modal" onclick="event.stopPropagation()">
                    <div class="modal-header">
                        <h3>Settings</h3>
                        <button class="btn btn-ghost" onclick="state.ui.showSettings = false; render()">
                            <i data-lucide="x"></i>
                        </button>
                    </div>
                    <div class="modal-body">
                        <div class="form-group">
                            <label class="form-label">Claude API Key</label>
                            <input type="password" class="form-input" 
                                   value="${state.settings.apiKey}"
                                   placeholder="sk-ant-api03-..."
                                   oninput="state.settings.apiKey = this.value">
                            <p style="font-size: 0.8rem; color: var(--text-muted); margin-top: 0.5rem;">
                                Verkrijgbaar op console.anthropic.com
                            </p>
                        </div>
                        <div class="form-group">
                            <label class="form-label">Proxy URL</label>
                            <input type="text" class="form-input" 
                                   value="${state.settings.proxyUrl}"
                                   oninput="state.settings.proxyUrl = this.value">
                        </div>
                    </div>
                    <div class="modal-footer">
                        <button class="btn btn-secondary" onclick="state.ui.showSettings = false; render()">
                            Annuleren
                        </button>
                        <button class="btn btn-primary" onclick="saveSettings()">
                            Opslaan
                        </button>
                    </div>
                </div>
            </div>
        `;
    }

    function renderSceneViewer() {
        if (!state.ui.showSceneViewer || !state.selectedScript) return '';

        const script = state.scripts[state.selectedScript];
        
        return `
            <div class="scene-viewer">
                <div class="header glass">
                    <div style="display: flex; align-items: center; gap: 1rem;">
                        <button class="btn btn-ghost" onclick="closeSceneViewer()">
                            <i data-lucide="arrow-left"></i>
                        </button>
                        <div>
                            <h2 style="font-size: 1.1rem;">${escapeHtml(script.title)}</h2>
                            <p style="font-size: 0.85rem; color: var(--text-secondary);">
                                ${script.stats.sceneCount} scenes â€¢ ${script.stats.characterCount} karakters
                            </p>
                        </div>
                    </div>
                </div>
                <div class="scene-content">
                    ${script.scenes.map(scene => `
                        <div style="margin-bottom: 3rem;">
                            <div class="scene-header-text">${escapeHtml(scene.header)}</div>
                            ${scene.content.slice(1).map(line => {
                                const trimmed = line.trim();
                                if (!trimmed) return '';
                                
                                // Check if it's a character name
                                if (trimmed === trimmed.toUpperCase() && trimmed.length > 1 && trimmed.length < 40) {
                                    return `<div class="scene-character">${escapeHtml(trimmed)}</div>`;
                                }
                                // Check if it's a parenthetical
                                if (trimmed.match(/^\([^)]+\)$/)) {
                                    return `<div class="scene-parenthetical">${escapeHtml(trimmed)}</div>`;
                                }
                                // Check if it might be dialogue (follows a character)
                                if (line.startsWith('    ') || line.startsWith('\t')) {
                                    return `<div class="scene-dialogue">${escapeHtml(trimmed)}</div>`;
                                }
                                // Action line
                                return `<div class="scene-action">${escapeHtml(trimmed)}</div>`;
                            }).join('')}
                        </div>
                    `).join('')}
                </div>
            </div>
        `;
    }

    function renderMainContent() {
        switch (state.activeTab) {
            case 'scripts': return renderScriptsTab();
            case 'writer': return renderWriterTab();
            case 'characters': return renderCharactersTab();
            case 'locations': return renderLocationsTab();
            case 'storyframe': return renderStoryframeTab();
            case 'continuity': return renderContinuityTab();
            case 'chat': return renderChatTab();
            case 'wisdom': return renderWisdomTab();
            default: return renderScriptsTab();
        }
    }

    // ============================================
    // WRITER ASSISTANT TAB RENDER
    // ============================================

    function renderWriterTab() {
        return `
            <div class="writer-container">
                <!-- Sub-tabs -->
                <div class="tabs-sub">
                    <button class="tab-sub ${state.writer.subTab === 'beats' ? 'active' : ''}"
                            onclick="state.writer.subTab = 'beats'; render()">
                        <i data-lucide="list-ordered" style="width:16px;height:16px;"></i>
                        Beat Planner
                    </button>
                    <button class="tab-sub ${state.writer.subTab === 'scene' ? 'active' : ''}"
                            onclick="state.writer.subTab = 'scene'; render()">
                        <i data-lucide="clapperboard" style="width:16px;height:16px;"></i>
                        Scene Builder
                    </button>
                    <button class="tab-sub ${state.writer.subTab === 'dialogue' ? 'active' : ''}"
                            onclick="state.writer.subTab = 'dialogue'; render()">
                        <i data-lucide="message-circle" style="width:16px;height:16px;"></i>
                        Dialoog Generator
                    </button>
                    <button class="tab-sub ${state.writer.subTab === 'conflict' ? 'active' : ''}"
                            onclick="state.writer.subTab = 'conflict'; render()">
                        <i data-lucide="flame" style="width:16px;height:16px;"></i>
                        Conflict Escalator
                    </button>
                    <button class="tab-sub ${state.writer.subTab === 'twist' ? 'active' : ''}"
                            onclick="state.writer.subTab = 'twist'; render()">
                        <i data-lucide="shuffle" style="width:16px;height:16px;"></i>
                        Plot Twist
                    </button>
                </div>

                ${state.writer.subTab === 'beats' ? renderBeatPlanner() : ''}
                ${state.writer.subTab === 'scene' ? renderSceneBuilder() : ''}
                ${state.writer.subTab === 'dialogue' ? renderDialogueGenerator() : ''}
                ${state.writer.subTab === 'conflict' ? renderConflictEscalator() : ''}
                ${state.writer.subTab === 'twist' ? renderTwistGenerator() : ''}
            </div>
        `;
    }

    // ============================================
    // SCENE BUILDER RENDER
    // ============================================

    function renderSceneBuilder() {
        const s = state.writer.scene;
        
        return `
            <div class="card">
                <div class="card-header">
                    <h3>ðŸŽ¬ Scene Builder</h3>
                    <span style="color: var(--text-secondary);">Genereer volledige scenes</span>
                </div>
                <div class="card-body">
                    <div class="scene-form">
                        <div>
                            <label class="form-label">INT / EXT</label>
                            <select class="form-input" onchange="state.writer.scene.intExt = this.value">
                                <option value="INT" ${s.intExt === 'INT' ? 'selected' : ''}>INT.</option>
                                <option value="EXT" ${s.intExt === 'EXT' ? 'selected' : ''}>EXT.</option>
                                <option value="INT/EXT" ${s.intExt === 'INT/EXT' ? 'selected' : ''}>INT/EXT.</option>
                            </select>
                        </div>
                        <div>
                            <label class="form-label">Tijd van de dag</label>
                            <select class="form-input" onchange="state.writer.scene.timeOfDay = this.value">
                                <option value="DAY" ${s.timeOfDay === 'DAY' ? 'selected' : ''}>DAY</option>
                                <option value="NIGHT" ${s.timeOfDay === 'NIGHT' ? 'selected' : ''}>NIGHT</option>
                                <option value="DAWN" ${s.timeOfDay === 'DAWN' ? 'selected' : ''}>DAWN</option>
                                <option value="DUSK" ${s.timeOfDay === 'DUSK' ? 'selected' : ''}>DUSK</option>
                                <option value="CONTINUOUS" ${s.timeOfDay === 'CONTINUOUS' ? 'selected' : ''}>CONTINUOUS</option>
                            </select>
                        </div>
                        <div class="scene-form-full">
                            <label class="form-label">Locatie *</label>
                            <input type="text" class="form-input" 
                                   placeholder="bijv. SARAH'S APPARTEMENT - WOONKAMER"
                                   value="${escapeHtml(s.location)}"
                                   oninput="state.writer.scene.location = this.value">
                        </div>
                        <div class="scene-form-full">
                            <label class="form-label">Karakters (komma-gescheiden)</label>
                            <input type="text" class="form-input" 
                                   placeholder="bijv. SARAH, MARK, DETECTIVE JANSEN"
                                   value="${s.characters.join(', ')}"
                                   oninput="state.writer.scene.characters = this.value.split(',').map(c => c.trim()).filter(c => c)">
                        </div>
                        <div class="scene-form-full">
                            <label class="form-label">Doel van de scene *</label>
                            <textarea class="form-input" style="min-height: 80px;"
                                      placeholder="Wat moet deze scene bereiken? Welke informatie moet onthuld worden? Welke emotie?"
                                      oninput="state.writer.scene.objective = this.value">${escapeHtml(s.objective)}</textarea>
                        </div>
                        <div>
                            <label class="form-label">Conflict</label>
                            <input type="text" class="form-input" 
                                   placeholder="Wat is het obstakel of de spanning?"
                                   value="${escapeHtml(s.conflict)}"
                                   oninput="state.writer.scene.conflict = this.value">
                        </div>
                        <div>
                            <label class="form-label">Toon</label>
                            <select class="form-input" onchange="state.writer.scene.tone = this.value">
                                <option value="neutral" ${s.tone === 'neutral' ? 'selected' : ''}>Neutraal</option>
                                <option value="tense" ${s.tone === 'tense' ? 'selected' : ''}>Gespannen</option>
                                <option value="romantic" ${s.tone === 'romantic' ? 'selected' : ''}>Romantisch</option>
                                <option value="comedic" ${s.tone === 'comedic' ? 'selected' : ''}>Komisch</option>
                                <option value="dramatic" ${s.tone === 'dramatic' ? 'selected' : ''}>Dramatisch</option>
                                <option value="action" ${s.tone === 'action' ? 'selected' : ''}>Actie</option>
                                <option value="horror" ${s.tone === 'horror' ? 'selected' : ''}>Horror</option>
                            </select>
                        </div>
                        <div class="scene-form-full">
                            ${renderMasterDropdown()}
                        </div>
                    </div>
                    
                    <div style="margin-top: 1.5rem; display: flex; gap: 0.5rem;">
                        <button class="btn btn-primary" onclick="generateScene()" ${state.writer.isGenerating ? 'disabled' : ''}>
                            ${state.writer.isGenerating ? '<span class="spinner"></span> Genereren...' : 'ðŸŽ¬ Genereer Scene'}
                        </button>
                        ${s.generatedScene ? `
                            <button class="btn btn-secondary" onclick="copyToClipboard(state.writer.scene.generatedScene, this)">
                                ðŸ“‹ Kopieer
                            </button>
                            <button class="btn btn-secondary" onclick="exportSceneToFountain()">
                                ðŸ’¾ Download .fountain
                            </button>
                        ` : ''}
                    </div>
                </div>
            </div>

            ${s.generatedScene ? `
                <div class="card" style="margin-top: 1rem;">
                    <div class="card-header">
                        <h3>Gegenereerde Scene</h3>
                    </div>
                    <div class="card-body">
                        <div class="scene-preview">${escapeHtml(s.generatedScene)}</div>
                    </div>
                </div>
            ` : ''}
        `;
    }

    // ============================================
    // DIALOGUE GENERATOR RENDER
    // ============================================

    function renderDialogueGenerator() {
        const d = state.writer.dialogue;
        
        return `
            <div class="card">
                <div class="card-header">
                    <h3>ðŸ’¬ Dialoog Generator</h3>
                    <span style="color: var(--text-secondary);">3 versies van dezelfde dialoog</span>
                </div>
                <div class="card-body">
                    <div class="scene-form">
                        <div>
                            <label class="form-label">Wie spreekt *</label>
                            <input type="text" class="form-input" 
                                   placeholder="bijv. SARAH"
                                   value="${escapeHtml(d.speaker)}"
                                   oninput="state.writer.dialogue.speaker = this.value">
                        </div>
                        <div>
                            <label class="form-label">Tegen wie</label>
                            <input type="text" class="form-input" 
                                   placeholder="bijv. MARK"
                                   value="${escapeHtml(d.listener)}"
                                   oninput="state.writer.dialogue.listener = this.value">
                        </div>
                        <div class="scene-form-full">
                            <label class="form-label">Wat wil ${d.speaker || 'de spreker'} bereiken? *</label>
                            <textarea class="form-input" style="min-height: 60px;"
                                      placeholder="bijv. Mark overtuigen om mee te doen aan het plan, zonder te onthullen dat ze al weet van zijn geheim"
                                      oninput="state.writer.dialogue.objective = this.value">${escapeHtml(d.objective)}</textarea>
                        </div>
                        <div class="scene-form-full">
                            <label class="form-label">Subtext (wat wordt NIET gezegd)</label>
                            <input type="text" class="form-input" 
                                   placeholder="bijv. Sarah is bang dat Mark haar zal verlaten"
                                   value="${escapeHtml(d.subtext)}"
                                   oninput="state.writer.dialogue.subtext = this.value">
                        </div>
                        <div>
                            <label class="form-label">Toon</label>
                            <select class="form-input" onchange="state.writer.dialogue.tone = this.value">
                                <option value="neutral" ${d.tone === 'neutral' ? 'selected' : ''}>Neutraal</option>
                                <option value="flirty" ${d.tone === 'flirty' ? 'selected' : ''}>Flirterig</option>
                                <option value="aggressive" ${d.tone === 'aggressive' ? 'selected' : ''}>Agressief</option>
                                <option value="sarcastic" ${d.tone === 'sarcastic' ? 'selected' : ''}>Sarcastisch</option>
                                <option value="vulnerable" ${d.tone === 'vulnerable' ? 'selected' : ''}>Kwetsbaar</option>
                                <option value="manipulative" ${d.tone === 'manipulative' ? 'selected' : ''}>Manipulatief</option>
                                <option value="professional" ${d.tone === 'professional' ? 'selected' : ''}>Professioneel</option>
                            </select>
                        </div>
                        <div class="scene-form-full">
                            ${renderMasterDropdown()}
                        </div>
                    </div>
                    
                    <button class="btn btn-primary" style="margin-top: 1.5rem;" 
                            onclick="generateDialogueOptions()" ${state.writer.isGenerating ? 'disabled' : ''}>
                        ${state.writer.isGenerating ? '<span class="spinner"></span> Genereren...' : 'ðŸ’¬ Genereer 3 Versies'}
                    </button>
                </div>
            </div>

            ${d.options.length > 0 ? `
                <div class="card" style="margin-top: 1rem;">
                    <div class="card-header">
                        <h3>Dialoog Opties</h3>
                    </div>
                    <div class="card-body">
                        <div class="dialogue-options">
                            ${d.options.map((opt, idx) => `
                                <div class="dialogue-option ${d.selectedOption === idx ? 'selected' : ''}"
                                     onclick="state.writer.dialogue.selectedOption = ${idx}; render()">
                                    <div class="dialogue-option-label">${opt.style}</div>
                                    <div style="font-size: 0.85rem; color: var(--text-secondary); margin-bottom: 0.75rem;">
                                        ${escapeHtml(opt.description)}
                                    </div>
                                    <div class="dialogue-preview">
                                        ${escapeHtml(opt.dialogue).replace(/\n/g, '<br>')}
                                    </div>
                                    <button class="copy-btn" style="margin-top: 0.5rem;" 
                                            onclick="event.stopPropagation(); copyToClipboard('${escapeHtml(opt.dialogue).replace(/'/g, "\\'")}', this)">
                                        ðŸ“‹ Kopieer
                                    </button>
                                </div>
                            `).join('')}
                        </div>
                    </div>
                </div>
            ` : ''}
        `;
    }

    // ============================================
    // CONFLICT ESCALATOR RENDER
    // ============================================

    function renderConflictEscalator() {
        const c = state.writer.conflict;
        
        return `
            <div class="card">
                <div class="card-header">
                    <h3>ðŸ”¥ Conflict Escalator</h3>
                    <span style="color: var(--text-secondary);">Van subtiel naar explosief</span>
                </div>
                <div class="card-body">
                    <div class="form-group">
                        <label class="form-label">Beschrijf je basisconflict *</label>
                        <textarea class="form-input" style="min-height: 100px;"
                                  placeholder="bijv. Sarah ontdekt dat haar collega Mark al maanden haar ideeÃ«n steelt en als de zijne presenteert bij de directie"
                                  oninput="state.writer.conflict.baseConflict = this.value">${escapeHtml(c.baseConflict)}</textarea>
                    </div>
                    
                    ${renderMasterDropdown()}
                    
                    <button class="btn btn-primary" onclick="generateConflictEscalations()" 
                            ${state.writer.isGenerating ? 'disabled' : ''}>
                        ${state.writer.isGenerating ? '<span class="spinner"></span> Genereren...' : 'ðŸ”¥ Escaleer Conflict'}
                    </button>
                </div>
            </div>

            ${c.escalations.length > 0 ? `
                <div class="card" style="margin-top: 1rem;">
                    <div class="card-header">
                        <h3>5 Escalatie Niveaus</h3>
                    </div>
                    <div class="card-body">
                        <div class="conflict-scale">
                            ${c.escalations.map(e => `
                                <div class="conflict-level level-${e.level}" 
                                     onclick="state.writer.conflict.selectedLevel = ${e.level}; render()">
                                    <div class="conflict-level-number">${e.level}</div>
                                    <div class="conflict-content">
                                        <div class="conflict-title">${escapeHtml(e.name)}</div>
                                        <div class="conflict-description">${escapeHtml(e.description)}</div>
                                        ${c.selectedLevel === e.level ? `
                                            <div style="margin-top: 0.75rem; padding: 0.75rem; background: var(--bg-secondary); border-radius: 6px; font-size: 0.9rem;">
                                                <strong>Scene voorbeeld:</strong><br>
                                                ${escapeHtml(e.example)}
                                            </div>
                                        ` : ''}
                                    </div>
                                </div>
                            `).join('')}
                        </div>
                    </div>
                </div>
            ` : ''}
        `;
    }

    // ============================================
    // PLOT TWIST GENERATOR RENDER
    // ============================================

    function renderTwistGenerator() {
        const t = state.writer.twist;
        
        return `
            <div class="card">
                <div class="card-header">
                    <h3>ðŸ”€ Plot Twist Generator</h3>
                    <span style="color: var(--text-secondary);">Verrassende wendingen</span>
                </div>
                <div class="card-body">
                    <div class="form-group">
                        <label class="form-label">Twist Categorie</label>
                        <div class="twist-categories">
                            ${Object.entries(twistCategories).map(([key, label]) => `
                                <button class="twist-category-btn ${t.category === key ? 'active' : ''}"
                                        onclick="state.writer.twist.category = '${key}'; render()">
                                    ${key === 'all' ? 'ðŸŽ²' : key === 'character' ? 'ðŸ‘¤' : key === 'perspective' ? 'ðŸ‘ï¸' : key === 'time' ? 'â°' : key === 'relationship' ? 'â¤ï¸' : 'ðŸŒ€'} ${label}
                                </button>
                            `).join('')}
                        </div>
                    </div>
                    
                    <div class="form-group">
                        <label class="form-label">Extra context (optioneel)</label>
                        <textarea class="form-input" style="min-height: 80px;"
                                  placeholder="Beschrijf je verhaal of specifieke elementen die je wilt twisten..."
                                  oninput="state.writer.twist.context = this.value">${escapeHtml(t.context)}</textarea>
                    </div>
                    
                    ${renderMasterDropdown()}
                    
                    <button class="btn btn-primary" onclick="generatePlotTwists()" 
                            ${state.writer.isGenerating ? 'disabled' : ''}>
                        ${state.writer.isGenerating ? '<span class="spinner"></span> Genereren...' : 'ðŸ”€ Genereer Twists'}
                    </button>
                </div>
            </div>

            ${t.twists.length > 0 ? `
                <div class="card" style="margin-top: 1rem;">
                    <div class="card-header">
                        <h3>Plot Twist Suggesties</h3>
                    </div>
                    <div class="card-body">
                        <div class="twist-results">
                            ${t.twists.map(twist => `
                                <div class="twist-card">
                                    <div style="display: flex; justify-content: space-between; align-items: start;">
                                        <div class="twist-title">${escapeHtml(twist.title)}</div>
                                        <span class="stat-badge">${twist.category}</span>
                                    </div>
                                    <div class="twist-setup"><strong>Setup:</strong> ${escapeHtml(twist.setup)}</div>
                                    <div style="margin: 0.5rem 0; padding: 0.75rem; background: rgba(245, 158, 11, 0.1); border-radius: 6px;">
                                        <strong>ðŸ”€ De Twist:</strong> ${escapeHtml(twist.reveal)}
                                    </div>
                                    <div style="font-size: 0.85rem; color: var(--text-secondary); margin-bottom: 0.5rem;">
                                        <strong>Waarom het werkt:</strong> ${escapeHtml(twist.impact)}
                                    </div>
                                    <div class="twist-example">ðŸŽ¬ Voorbeeld: ${escapeHtml(twist.example)}</div>
                                </div>
                            `).join('')}
                        </div>
                    </div>
                </div>
            ` : ''}
        `;
    }

    function renderBeatPlanner() {
        const method = writingMethods[state.writer.method];
        const beats = getCurrentMethodBeats();
        const currentBeat = beats[state.writer.currentBeat];
        
        // Calculate progress
        const filledBeats = beats.filter(b => getBeatContent(b.id) && getBeatContent(b.id).length > 10).length;
        const progressPercent = Math.round((filledBeats / beats.length) * 100);

        return `
            <!-- Project Setup -->
            <div class="card" style="margin-bottom: 1rem;">
                <div class="card-body">
                    <div class="project-setup" style="display: grid; grid-template-columns: 1fr 1fr; gap: 1rem;">
                        <div>
                            <label class="form-label">Schrijfmethode</label>
                            <div class="method-selector">
                                ${Object.entries(writingMethods).map(([key, m]) => `
                                    <button class="method-btn ${state.writer.method === key ? 'active' : ''}"
                                            onclick="state.writer.method = '${key}'; state.writer.currentBeat = 0; saveState(); render()">
                                        ${m.name}
                                    </button>
                                `).join('')}
                            </div>
                        </div>
                        <div>
                            <label class="form-label">Genre</label>
                            <select class="form-input" onchange="state.writer.genre = this.value; saveState();" style="padding: 0.5rem;">
                                <option value="thriller" ${state.writer.genre === 'thriller' ? 'selected' : ''}>Thriller</option>
                                <option value="drama" ${state.writer.genre === 'drama' ? 'selected' : ''}>Drama</option>
                                <option value="comedy" ${state.writer.genre === 'comedy' ? 'selected' : ''}>Comedy</option>
                                <option value="horror" ${state.writer.genre === 'horror' ? 'selected' : ''}>Horror</option>
                                <option value="scifi" ${state.writer.genre === 'scifi' ? 'selected' : ''}>Sci-Fi</option>
                                <option value="romance" ${state.writer.genre === 'romance' ? 'selected' : ''}>Romance</option>
                                <option value="action" ${state.writer.genre === 'action' ? 'selected' : ''}>Action</option>
                            </select>
                        </div>
                    </div>
                    <div style="margin-top: 1rem;">
                        <label class="form-label">Logline (1-2 zinnen over je verhaal)</label>
                        <input type="text" class="form-input" 
                               placeholder="Een [held] moet [doel] ondanks [obstakel]..."
                               value="${escapeHtml(state.writer.logline)}"
                               oninput="state.writer.logline = this.value; saveState();">
                    </div>
                    <div style="margin-top: 1rem;">
                        ${renderMasterDropdown()}
                    </div>
                </div>
            </div>

            <!-- Beat Overview -->
            <div class="card" style="margin-bottom: 1rem;">
                <div class="card-header">
                    <div>
                        <h3>${method.name} - ${method.author}</h3>
                        <div style="display: flex; align-items: center; gap: 1rem; margin-top: 0.5rem;">
                            <div class="progress-bar" style="width: 200px;">
                                <div class="progress-fill" style="width: ${progressPercent}%;"></div>
                            </div>
                            <span style="font-size: 0.85rem; color: var(--text-secondary);">
                                ${filledBeats}/${beats.length} beats (${progressPercent}%)
                            </span>
                        </div>
                    </div>
                    <div style="display: flex; gap: 0.5rem;">
                        <button class="btn btn-secondary" onclick="state.ui.showExportModal = true; render()">
                            <i data-lucide="download"></i>
                            Export
                        </button>
                    </div>
                </div>
                <div class="card-body">
                    <div class="beat-grid">
                        ${beats.map((beat, idx) => {
                            const content = getBeatContent(beat.id);
                            const isActive = idx === state.writer.currentBeat;
                            const isCompleted = content && content.length > 10;
                            return `
                                <div class="beat-card ${isActive ? 'active' : ''} ${isCompleted ? 'completed' : ''}"
                                     onclick="state.writer.currentBeat = ${idx}; state.writer.suggestions = []; render()">
                                    <div class="beat-number">Beat ${beat.id} â€¢ p.${beat.page}</div>
                                    <div class="beat-name">${beat.name}</div>
                                    <div class="beat-status ${isCompleted ? 'filled' : 'empty'}">
                                        ${isCompleted ? 'âœ“ Ingevuld' : 'â—‹ Leeg'}
                                    </div>
                                </div>
                            `;
                        }).join('')}
                    </div>
                </div>
            </div>

            <!-- Beat Editor -->
            ${currentBeat ? `
                <div class="beat-editor">
                    <div class="beat-editor-header">
                        <h3>Beat ${currentBeat.id}: ${currentBeat.name}</h3>
                        <span style="color: var(--text-secondary);">Pagina ${currentBeat.page}</span>
                    </div>
                    <div class="beat-editor-body">
                        <div class="beat-description">
                            ðŸ“– ${currentBeat.description}
                        </div>
                        
                        <textarea class="beat-textarea" 
                                  placeholder="Schrijf hier je idee voor deze beat..."
                                  oninput="setBeatContent(${currentBeat.id}, this.value)"
                        >${escapeHtml(getBeatContent(currentBeat.id))}</textarea>
                        
                        <div class="suggestion-buttons">
                            <button class="btn btn-primary" onclick="generateBeatSuggestions(getCurrentMethodBeats()[${state.writer.currentBeat}])"
                                    ${state.writer.isGenerating ? 'disabled' : ''}>
                                ${state.writer.isGenerating ? '<span class="spinner"></span> Genereren...' : 'ðŸ¤– AI Suggesties'}
                            </button>
                            <button class="btn btn-secondary" onclick="showRandomMasterTip()">
                                ðŸ’¡ Meester Tip
                            </button>
                        </div>
                        
                        ${state.writer.suggestions.length > 0 ? `
                            <div class="suggestions-container">
                                ${state.writer.suggestions.map(s => `
                                    <div class="suggestion-card ${s.type}" onclick="selectSuggestion(${JSON.stringify(s).replace(/"/g, '&quot;')})">
                                        <div class="suggestion-label ${s.type}">
                                            ${s.type === 'conventional' ? 'ðŸŸ¢ CONVENTIONEEL' : s.type === 'surprising' ? 'ðŸŸ¡ VERRASSEND' : 'ðŸ”´ GEDURFD'}
                                        </div>
                                        <div style="font-weight: 600; margin-bottom: 0.25rem;">${escapeHtml(s.title)}</div>
                                        <div class="suggestion-text">${escapeHtml(s.description)}</div>
                                        <div style="font-size: 0.8rem; color: var(--text-muted); margin-top: 0.5rem;">
                                            ðŸ’¡ ${escapeHtml(s.reasoning || '')}
                                        </div>
                                    </div>
                                `).join('')}
                            </div>
                        ` : ''}
                        
                        <div class="beat-nav">
                            <button class="btn btn-secondary" 
                                    onclick="state.writer.currentBeat = Math.max(0, state.writer.currentBeat - 1); state.writer.suggestions = []; render()"
                                    ${state.writer.currentBeat === 0 ? 'disabled' : ''}>
                                â† Vorige Beat
                            </button>
                            <button class="btn btn-secondary"
                                    onclick="state.writer.currentBeat = Math.min(${beats.length - 1}, state.writer.currentBeat + 1); state.writer.suggestions = []; render()"
                                    ${state.writer.currentBeat === beats.length - 1 ? 'disabled' : ''}>
                                Volgende Beat â†’
                            </button>
                        </div>
                    </div>
                </div>
            ` : ''}
        `;
    }

    // Export Modal Render
    function renderExportModal() {
        if (!state.ui.showExportModal) return '';
        
        return `
            <div class="modal-overlay" onclick="state.ui.showExportModal = false; render()">
                <div class="modal" onclick="event.stopPropagation()">
                    <div class="modal-header">
                        <h3>ðŸ“¥ Exporteer Je Werk</h3>
                        <button class="btn btn-ghost" onclick="state.ui.showExportModal = false; render()">
                            <i data-lucide="x"></i>
                        </button>
                    </div>
                    <div class="modal-body">
                        <div class="export-options">
                            <div class="export-option" onclick="exportBeatsToText(); state.ui.showExportModal = false; render()">
                                <i data-lucide="file-text"></i>
                                <div class="export-option-title">Text (.txt)</div>
                                <div class="export-option-desc">Simpel tekstbestand</div>
                            </div>
                            <div class="export-option" onclick="exportBeatsToJSON(); state.ui.showExportModal = false; render()">
                                <i data-lucide="braces"></i>
                                <div class="export-option-title">JSON (.json)</div>
                                <div class="export-option-desc">Gestructureerde data</div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        `;
    }

    function renderMastersDatabase() {
        const filteredMasters = getFilteredMasters();

        return `
            <div class="card">
                <div class="card-header">
                    <h3>ðŸŽ“ 100 Meester Schrijvers</h3>
                    <span style="color: var(--text-secondary);">${filteredMasters.length} schrijvers</span>
                </div>
                <div class="card-body">
                    <div class="category-filter">
                        ${Object.entries(masterCategories).map(([key, label]) => `
                            <button class="filter-btn ${state.writer.masterFilter === key ? 'active' : ''}"
                                    onclick="state.writer.masterFilter = '${key}'; render()">
                                ${key === 'all' ? 'ðŸŒŸ' : key === 'structure' ? 'ðŸ—ï¸' : key === 'character' ? 'ðŸ‘¤' : key === 'dialogue' ? 'ðŸ’¬' : key === 'tv' ? 'ðŸ“º' : key === 'comedy' ? 'ðŸ˜‚' : key === 'horror' ? 'ðŸ‘»' : key === 'scifi' ? 'ðŸš€' : 'ðŸŒ'} ${label}
                            </button>
                        `).join('')}
                    </div>
                    
                    <div class="masters-grid">
                        ${filteredMasters.map(master => `
                            <div class="master-card" onclick="showMasterDetailModal(${master.id})">
                                <div class="master-name">${master.name}</div>
                                <div class="master-works">${escapeHtml(master.works)}</div>
                                <div class="master-technique">ðŸŽ¯ ${escapeHtml(master.technique)}</div>
                                <div style="margin-top: 0.5rem; font-size: 0.85rem; font-style: italic; color: var(--text-secondary);">
                                    "${escapeHtml(master.tip)}"
                                </div>
                            </div>
                        `).join('')}
                    </div>
                </div>
            </div>
        `;
    }

    function renderMasterDetailModal() {
        if (!state.ui.showMasterDetail) return '';
        
        const master = masterWriters.find(m => m.id === state.ui.showMasterDetail);
        if (!master) return '';

        const categoryEmoji = {
            structure: 'ðŸ—ï¸',
            character: 'ðŸ‘¤',
            dialogue: 'ðŸ’¬',
            tv: 'ðŸ“º',
            comedy: 'ðŸ˜‚',
            horror: 'ðŸ‘»',
            scifi: 'ðŸš€',
            international: 'ðŸŒ'
        };

        return `
            <div class="modal-overlay" onclick="closeMasterDetailModal()">
                <div class="modal master-detail-modal" onclick="event.stopPropagation()">
                    <div class="modal-header">
                        <h3>Meester Profiel</h3>
                        <button class="btn btn-ghost" onclick="closeMasterDetailModal()">
                            <i data-lucide="x"></i>
                        </button>
                    </div>
                    <div class="modal-body">
                        <div class="master-detail-header">
                            <div class="master-avatar">${categoryEmoji[master.category] || 'ðŸŽ¬'}</div>
                            <div class="master-info">
                                <h2>${master.name}</h2>
                                <p>${escapeHtml(master.works)}</p>
                            </div>
                        </div>
                        
                        <div class="master-technique-box">
                            <div class="master-technique-label">ðŸŽ¯ KERNTECHNIEK</div>
                            <div style="font-weight: 600; font-size: 1.1rem;">${escapeHtml(master.technique)}</div>
                        </div>
                        
                        <div class="master-quote-box">
                            <blockquote>"${escapeHtml(master.tip)}"</blockquote>
                        </div>

                        <div style="margin-top: 1rem;">
                            <div style="font-size: 0.85rem; color: var(--text-secondary); margin-bottom: 0.5rem;">
                                Categorie: <span class="stat-badge">${masterCategories[master.category]}</span>
                            </div>
                        </div>
                    </div>
                    <div class="modal-footer">
                        <button class="btn btn-secondary" onclick="closeMasterDetailModal()">
                            Sluiten
                        </button>
                        <button class="btn btn-primary" onclick="applyMasterStyle(masterWriters.find(m => m.id === ${master.id}))">
                            <i data-lucide="wand-2"></i>
                            Pas stijl toe in Chat
                        </button>
                    </div>
                </div>
            </div>
        `;
    }

    function showRandomMasterTip() {
        const master = getRandomMasterTip();
        alert(`ðŸ’¡ Tip van ${master.name}:\n\n"${master.tip}"\n\nðŸŽ¯ Techniek: ${master.technique}\nðŸŽ¬ Bekend van: ${master.works}`);
    }

    function render() {
        const app = document.getElementById('app');
        app.innerHTML = `
            ${renderHeader()}
            ${renderNav()}
            <main class="main-content">
                ${renderMainContent()}
            </main>
            ${renderSettingsModal()}
            ${renderSceneViewer()}
            ${renderMasterDetailModal()}
            ${renderExportModal()}
        `;
        
        // Initialize Lucide icons
        lucide.createIcons();

        // Setup drag and drop
        setupDragAndDrop();

        // Scroll chat to bottom
        if (state.activeTab === 'chat') {
            const chatMessages = document.getElementById('chatMessages');
            if (chatMessages) {
                chatMessages.scrollTop = chatMessages.scrollHeight;
            }
        }
    }

    // ============================================
    // EVENT HANDLERS
    // ============================================

    function setupDragAndDrop() {
        const uploadZone = document.getElementById('uploadZone');
        if (!uploadZone) return;

        uploadZone.addEventListener('dragover', (e) => {
            e.preventDefault();
            uploadZone.classList.add('dragover');
        });

        uploadZone.addEventListener('dragleave', () => {
            uploadZone.classList.remove('dragover');
        });

        uploadZone.addEventListener('drop', async (e) => {
            e.preventDefault();
            uploadZone.classList.remove('dragover');
            
            const files = Array.from(e.dataTransfer.files);
            await processFiles(files);
        });
    }

    async function handleFileUpload(event) {
        const files = Array.from(event.target.files);
        await processFiles(files);
        event.target.value = ''; // Reset input
    }

    async function processFiles(files) {
        state.ui.isProcessing = true;
        render();

        for (const file of files) {
            try {
                await processFile(file);
            } catch (error) {
                alert(`Fout bij verwerken van ${file.name}: ${error.message}`);
            }
        }

        state.ui.isProcessing = false;
        render();
    }

    function viewScript(index) {
        state.selectedScript = index;
        state.ui.showSceneViewer = true;
        render();
    }

    function closeSceneViewer() {
        state.ui.showSceneViewer = false;
        state.selectedScript = null;
        render();
    }

    function deleteScript(index) {
        if (confirm('Weet je zeker dat je dit script wilt verwijderen?')) {
            state.scripts.splice(index, 1);
            rebuildIndexes();
            saveState();
            render();
        }
    }

    function saveSettings() {
        saveState();
        state.ui.showSettings = false;
        render();
    }

    function sendMessage() {
        const input = document.getElementById('chatInput');
        if (input && input.value.trim()) {
            sendChatMessage(input.value.trim());
            input.value = '';
        }
    }

    // ============================================
    // INITIALIZATION
    // ============================================

    // Set PDF.js worker
    pdfjsLib.GlobalWorkerOptions.workerSrc = 'https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.174/pdf.worker.min.js';

    // Load state and render
    loadState();
    render();

    // Make functions available globally
    window.handleFileUpload = handleFileUpload;
    window.viewScript = viewScript;
    window.closeSceneViewer = closeSceneViewer;
    window.deleteScript = deleteScript;
    window.saveSettings = saveSettings;
    window.sendMessage = sendMessage;
    window.generateStoryframe = generateStoryframe;
    window.exportStoryframe = exportStoryframe;
    window.state = state;
    window.render = render;
    window.saveState = saveState;
    
    // Writer Assistant functions
    window.getCurrentMethodBeats = getCurrentMethodBeats;
    window.getBeatContent = getBeatContent;
    window.setBeatContent = setBeatContent;
    window.generateBeatSuggestions = generateBeatSuggestions;
    window.selectSuggestion = selectSuggestion;
    window.getFilteredMasters = getFilteredMasters;
    window.showMasterDetail = showMasterDetailModal;
    window.showMasterDetailModal = showMasterDetailModal;
    window.closeMasterDetailModal = closeMasterDetailModal;
    window.showRandomMasterTip = showRandomMasterTip;
    window.getRandomMasterTip = getRandomMasterTip;
    window.writingMethods = writingMethods;
    window.masterWriters = masterWriters;
    
    // New feature functions
    window.generateScene = generateScene;
    window.generateDialogueOptions = generateDialogueOptions;
    window.generateConflictEscalations = generateConflictEscalations;
    window.generatePlotTwists = generatePlotTwists;
    window.twistCategories = twistCategories;
    window.exportBeatsToText = exportBeatsToText;
    window.exportBeatsToJSON = exportBeatsToJSON;
    window.exportSceneToFountain = exportSceneToFountain;
    window.copyToClipboard = copyToClipboard;
    window.applyMasterStyle = applyMasterStyle;
    window.renderMasterDropdown = renderMasterDropdown;
    window.getMasterPromptText = getMasterPromptText;
    </script>
</body>
</html>
